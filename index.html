<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title data-i18n="app_title">Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ø´Ù‡Ø±ÙŠ</title>

<!-- Bootstrap RTL -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
<!-- SheetJS -->
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<style>
  :root{
    --brand:#0d47a1;
  }
  body{background:#fff;color:#222}
  .navbar{background:var(--brand)}
  .navbar .navbar-brand,.navbar .btn,.navbar .nav-link{color:#fff}
  .navbar .btn.btn-light{color:var(--brand)}
  .sidebar{min-height:100vh;background:#f7f9fb;border-left:1px solid #e7eef4}
  .sidebar .list-group-item{border:none;background:transparent}
  .sidebar .list-group-item.active{background:var(--brand);color:#fff;border-radius:.5rem}
  .card{box-shadow:0 2px 8px rgba(0,0,0,.06);border:1px solid #e9ecef}
  .table td input[type="text"], .table td input[type="number"]{width:100%;border:none;background:transparent}
  .table td input:focus{outline:none;border-bottom:1px solid #0d6efd}
  .muted{color:#6c757d}
  .profit-pos{color:#198754;font-weight:700}
  .profit-neg{color:#dc3545;font-weight:700}
  .section-title{font-weight:700}
  .cloud-badge{font-size:.8rem;padding:.25rem .5rem;border-radius:.5rem}
  .cloud-ok{background:#e6f4ea;color:#137333}
  .cloud-err{background:#fde8e8;color:#b42318}
  @media print{
    .no-print{display:none!important}
    .sidebar{display:none}
    .container-fluid{padding:0}
    main{width:100%}
    .card{box-shadow:none}
  }
</style>
</head>
<body>

<!-- ====== NAVBAR ====== -->
<nav class="navbar navbar-expand-lg">
  <div class="container-fluid">
    <a class="navbar-brand" href="#" data-i18n="app_title">ğŸ“Š Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ø´Ù‡Ø±ÙŠ</a>

    <div class="ms-auto d-flex gap-2 align-items-center">
      <!-- language -->
      <button id="langBtn" class="btn btn-outline-light btn-sm no-print" title="Ù„ØºØ© / Language">Ø¹Ø±Ø¨ÙŠ / EN</button>

      <!-- cloud controls -->
      <span id="cloudState" class="cloud-badge cloud-err no-print" data-i18n="cloud_local_only">ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙÙ‚Ø·</span>
      <button class="btn btn-light btn-sm no-print" id="btnCloudSave">ğŸ’¾ <span data-i18n="save_cloud">Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©</span></button>
      <button class="btn btn-light btn-sm no-print" id="btnCloudLoad">â˜ï¸ <span data-i18n="load_cloud">Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©</span></button>

      <!-- io -->
      <input type="file" id="importFile" class="d-none" accept=".json" />
      <button class="btn btn-light btn-sm no-print" onclick="document.getElementById('importFile').click()">ğŸ“¥ <span data-i18n="import">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</span></button>
      <button class="btn btn-light btn-sm no-print" onclick="exportJSON()">ğŸ“¤ JSON</button>
      <button class="btn btn-light btn-sm no-print" onclick="exportExcel()">ğŸ“Š Excel</button>
      <button class="btn btn-light btn-sm no-print" onclick="window.print()">ğŸ–¨ï¸ <span data-i18n="print">Ø·Ø¨Ø§Ø¹Ø©</span></button>
    </div>
  </div>
</nav>

<div class="container-fluid">
  <div class="row g-0">
    <!-- ====== SIDEBAR ====== -->
    <aside class="col-12 col-lg-3 col-xl-2 sidebar p-3">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <h6 class="m-0 text-muted" data-i18n="branches">Ø§Ù„ÙØ±ÙˆØ¹</h6>
        <button class="btn btn-primary btn-sm" onclick="addBranch()">â• <span data-i18n="add_branch">Ø¥Ø¶Ø§ÙØ© ÙØ±Ø¹</span></button>
      </div>
      <div id="branchList" class="list-group mb-4"></div>

      <div class="mb-3">
        <h6 class="text-muted" data-i18n="admin_dist_settings">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ</h6>
        <div id="adminSettings" class="vstack gap-2"></div>
        <small class="text-muted d-block mt-2" data-i18n="admin_hint">
          * Ø§Ù„ÙØ±ÙˆØ¹ Ø§Ù„Ù…ÙØ¹Ù‘ÙÙ„Ø© ÙÙ‚Ø· ØªØªØ­Ù…Ù„ Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ Ø§Ù„Ù…Ù‚Ø³Ù‘Ø· Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± â€œØªÙˆØ²ÙŠØ¹ Ø¹Ù„Ù‰ Ø§Ù„ÙØ±ÙˆØ¹â€.
        </small>
      </div>
      <div class="mt-4">
        <button class="btn btn-outline-danger btn-sm" onclick="if(confirm(t('confirm_wipe'))){localStorage.removeItem(STORE_KEY);location.reload()}">
          <span data-i18n="wipe_all">Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
        </button>
      </div>
    </aside>

    <!-- ====== MAIN ====== -->
    <main class="col-12 col-lg-9 col-xl-10 p-3">
      <div class="d-flex align-items-center gap-3 flex-wrap">
        <h4 id="branchTitle" class="m-0">â€”</h4>
        <div class="ms-auto d-flex gap-2 align-items-center">
          <label class="muted" data-i18n="report_month">Ø´Ù‡Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ±</label>
          <input type="month" id="monthCurrent" class="form-control form-control-sm" style="width:160px">
          <label class="muted" data-i18n="compare_with">Ù…Ù‚Ø§Ø±Ù†Ø© Ù…Ø¹</label>
          <input type="month" id="monthCompare" class="form-control form-control-sm" style="width:160px">
          <button class="btn btn-outline-secondary btn-sm" onclick="copyFromPrevious()"><span data-i18n="copy_from_cmp">Ù†Ø³Ø® Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ù‚Ø§Ø±ÙÙ†</span></button>
          <button class="btn btn-outline-primary btn-sm" onclick="openInstallment()">â• <span data-i18n="add_installment">Ù…ØµØ±ÙˆÙ Ù…Ù‚Ø³Ù‘Ø·</span></button>
        </div>
      </div>

      <hr/>

      <!-- INCOME -->
      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span class="section-title" data-i18n="income">Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</span>
          <button class="btn btn-sm btn-outline-primary" onclick="addRow('income')">â• <span data-i18n="add_item">Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯</span></button>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-bordered m-0">
              <thead class="table-light">
                <tr>
                  <th style="width:55%" data-i18n="col_item">Ø§Ù„Ø¨Ù†Ø¯</th>
                  <th style="width:25%" data-i18n="col_amount">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                  <th style="width:20%" class="no-print" data-i18n="actions">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
              </thead>
              <tbody id="tbl-income"></tbody>
              <tfoot>
                <tr class="table-light">
                  <th data-i18n="sum_income">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</th>
                  <th id="sum-income">0</th><th></th>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>

      <!-- OPERATING -->
      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span class="section-title" data-i18n="operating_exp">Ù…ØµØ±ÙˆÙØ§Øª ØªØ´ØºÙŠÙ„</span>
          <button class="btn btn-sm btn-outline-primary" onclick="addRow('operating')">â• <span data-i18n="add_item">Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯</span></button>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-bordered m-0">
              <thead class="table-light">
                <tr>
                  <th style="width:55%" data-i18n="col_item">Ø§Ù„Ø¨Ù†Ø¯</th>
                  <th style="width:25%" data-i18n="col_amount">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                  <th style="width:20%" class="no-print" data-i18n="actions">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
              </thead>
              <tbody id="tbl-operating"></tbody>
              <tfoot>
                <tr class="table-light">
                  <th data-i18n="sum_operating">Ù…Ø¬Ù…ÙˆØ¹ Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ØªØ´ØºÙŠÙ„</th>
                  <th id="sum-operating">0</th><th></th>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>

      <!-- ADMIN -->
      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span class="section-title" data-i18n="admin_exp">Ù…ØµØ±ÙˆÙØ§Øª Ø¥Ø¯Ø§Ø±ÙŠØ©</span>
          <button class="btn btn-sm btn-outline-primary" onclick="addRow('admin')">â• <span data-i18n="add_item">Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯</span></button>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-bordered m-0">
              <thead class="table-light">
                <tr>
                  <th style="width:55%" data-i18n="col_item">Ø§Ù„Ø¨Ù†Ø¯</th>
                  <th style="width:25%" data-i18n="col_amount">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                  <th style="width:20%" class="no-print" data-i18n="actions">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
              </thead>
              <tbody id="tbl-admin"></tbody>
              <tfoot>
                <tr class="table-light">
                  <th data-i18n="sum_admin">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©</th>
                  <th id="sum-admin">0</th><th></th>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>

      <!-- SUMMARY -->
      <div class="card">
        <div class="card-header section-title" data-i18n="summary">Ø§Ù„Ù…Ù„Ø®Øµ</div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-3"><div class="p-3 border rounded bg-light"><span data-i18n="sum_income">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</span>: <b id="s-inc">0</b></div></div>
            <div class="col-md-3"><div class="p-3 border rounded bg-light"><span data-i18n="sum_expenses">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</span>: <b id="s-exp">0</b></div></div>
            <div class="col-md-3"><div class="p-3 border rounded bg-light"><span data-i18n="profit">Ø§Ù„Ø±Ø¨Ø­</span>: <b id="s-profit" class="profit-pos">0</b></div></div>
            <div class="col-md-3"><div class="p-3 border rounded bg-light"><span data-i18n="margin">Ù†Ø³Ø¨Ø© Ø§Ù„Ø±Ø¨Ø­</span>: <b id="s-margin">0%</b></div></div>
            <div class="col-12">
              <div class="p-3 border rounded">
                <span data-i18n="compare_with_month">Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ù…Ø¹</span> <span id="cmp-month" class="muted">â€”</span>:
                <span data-i18n="delta_amount">ÙØ±Ù‚ Ø§Ù„Ù…Ø¨Ù„Øº</span> <b id="cmp-amt">0</b> |
                <span data-i18n="delta_pct">ÙØ±Ù‚ Ø§Ù„Ù†Ø³Ø¨Ø©</span> <b id="cmp-pct">0%</b>
              </div>
            </div>
          </div>
        </div>
      </div>

    </main>
  </div>
</div>

<!-- ====== MODAL: INSTALLMENT ====== -->
<div class="modal fade" id="installmentModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title" data-i18n="add_installment">Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ Ù…Ù‚Ø³Ù‘Ø·</h6>
        <button class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2">
          <label class="form-label" data-i18n="item_name">Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ø¯</label>
          <input id="inst-name" class="form-control" placeholder="Ù…Ø«Ø§Ù„: ØµÙŠØ§Ù†Ø© Ø³Ù†ÙˆÙŠØ©">
        </div>
        <div class="mb-2">
          <label class="form-label" data-i18n="section">Ø§Ù„Ù‚Ø³Ù…</label>
          <select id="inst-section" class="form-select">
            <option value="operating" data-i18n="operating_exp">ØªØ´ØºÙŠÙ„</option>
            <option value="admin" data-i18n="admin_exp">Ø¥Ø¯Ø§Ø±ÙŠ</option>
          </select>
        </div>
        <div class="row g-2">
          <div class="col-6">
            <label class="form-label" data-i18n="total_amount">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº</label>
            <input id="inst-total" type="number" class="form-control" value="0">
          </div>
          <div class="col-6">
            <label class="form-label" data-i18n="months_count">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ù‡Ø±</label>
            <input id="inst-months" type="number" class="form-control" value="3" min="1">
          </div>
        </div>
        <div class="row g-2 mt-1">
          <div class="col-6">
            <label class="form-label" data-i18n="start_month">Ø´Ù‡Ø± Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</label>
            <input id="inst-start" type="month" class="form-control">
          </div>
          <div class="col-6">
            <label class="form-label" data-i18n="scope">Ø§Ù„Ù†Ø·Ø§Ù‚</label>
            <select id="inst-scope" class="form-select">
              <option value="single" data-i18n="scope_single">Ù‡Ø°Ø§ Ø§Ù„ÙØ±Ø¹ ÙÙ‚Ø·</option>
              <option value="weighted" data-i18n="scope_weighted">ØªÙˆØ²ÙŠØ¹ Ø¹Ù„Ù‰ Ø§Ù„ÙØ±ÙˆØ¹ Ø­Ø³Ø¨ Ø§Ù„Ø£ÙˆØ²Ø§Ù†</option>
            </select>
          </div>
        </div>
        <small class="text-muted d-block mt-2" data-i18n="inst_hint">
          Ø³ÙŠÙØ­Ù…Ù‘ÙÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ ÙƒÙ„ Ø´Ù‡Ø±: (Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ã· Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ù‡Ø±). ÙˆØ¥Ø°Ø§ Ø§Ø®ØªØ±Øª â€œØªÙˆØ²ÙŠØ¹ Ø¹Ù„Ù‰ Ø§Ù„ÙØ±ÙˆØ¹â€ ÙØ³ÙŠÙÙ‚Ø³Ù‘ÙÙ… Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø´Ù‡Ø±ÙŠ Ø­Ø³Ø¨ Ø£ÙˆØ²Ø§Ù† Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ù„Ù„ÙØ±ÙˆØ¹ Ø§Ù„Ù…ÙØ¹Ù‘Ù„Ø©.
        </small>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="cancel">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn btn-primary" onclick="saveInstallment()" data-i18n="save">Ø­ÙØ¸</button>
      </div>
    </div>
  </div>
</div>

<!-- ====== SCRIPTS ====== -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* -------------------- Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ø­Ø§Ø¨Ø© -------------------- */
/** Ø¶ÙØ¹ Ø±Ø§Ø¨Ø· WebApp Ù‡Ù†Ø§ (Ø£Ù†Øª Ø£Ø¹Ø·ÙŠØªÙ†ÙŠ Ù‡Ø°Ø§): **/
const API_URL = "https://script.google.com/macros/s/AKfycbywnjmaNd7RltspzDNnaSz6_TyG785jH_K-mIqfpP33-vfLkcSodSHiHs_lcB4PPESG/exec";

/** Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ Ù…Ø¨Ø³Ù‘Ø·:
 *  POST {op:'save', payload: <DB object>}  -> {ok:true}
 *  GET  ?op=load                             -> {ok:true, payload:{...}}
 *  (Ù„Ùˆ Ø³ÙƒØ±Ø¨ØªÙƒ ÙŠØ³ØªØ®Ø¯Ù… Ø£Ø³Ù…Ø§Ø¡ Ù…Ø®ØªÙ„ÙØ©ØŒ ÙÙ‚Ø· Ø¹Ø¯Ù‘Ù„ Ø­Ù‚ÙˆÙ„ op/param Ø¨Ø³Ù‡ÙˆÙ„Ø© Ù‡Ù†Ø§)
 */
async function cloudSave(){
  try{
    const res = await fetch(API_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({op:'save', payload: DB})
    });
    const data = await res.json();
    if(data && data.ok){
      setCloudState(true, t('cloud_saved_ok'));
    }else{
      throw new Error('bad response');
    }
  }catch(e){
    setCloudState(false, t('cloud_error'));
  }
}
async function cloudLoad(){
  try{
    const res = await fetch(API_URL + '?op=load', {method:'GET'});
    const data = await res.json();
    if(data && data.ok && data.payload){
      DB = data.payload;
      save(); // sync Ù…Ø­Ù„ÙŠÙ‹Ø§
      location.reload();
    }else{
      throw new Error('bad response');
    }
  }catch(e){
    alert(t('cloud_error_long'));
    setCloudState(false, t('cloud_local_only'));
  }
}
function setCloudState(ok,msg){
  const el = document.getElementById('cloudState');
  el.textContent = msg || (ok ? t('cloud_on') : t('cloud_local_only'));
  el.className = 'cloud-badge ' + (ok ? 'cloud-ok' : 'cloud-err');
}

/* -------------------- Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø­ÙØ¸ -------------------- */
const STORE_KEY = "profit_manager_v2_i18n_cloud";
const DEFAULT = {
  branches: [
    {id: cid(), name:"ÙƒÙ„Ø§Ø³ÙŠÙƒ", active:true, weight:1, includeAdmin:true},
    {id: cid(), name:"Ù…ÙˆØ¯Ø±Ù†",  active:true, weight:1, includeAdmin:true},
    {id: cid(), name:"Ù‡Ø¬Ø± ÙÙˆØ¯",active:true, weight:1, includeAdmin:false},
    {id: cid(), name:"ÙØ±Ø¹ 3",  active:true, weight:1, includeAdmin:true}
  ],
  months: {},         // {"YYYY-MM": {branchId: {income:[], operating:[], admin:[]}}}
  installments: [],   // Ø³Ù„Ø§Ø³Ù„ Ù…Ù‚Ø³Ø·Ø©
  lang: "ar"          // Ø§Ù„Ù„ØºØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
};
function load(){ return JSON.parse(localStorage.getItem(STORE_KEY) || JSON.stringify(DEFAULT)); }
function save(){ localStorage.setItem(STORE_KEY, JSON.stringify(DB)); }
function cid(){ return Math.random().toString(36).slice(2,10); }

let DB = load();
let currentBranchId = DB.branches[0]?.id || null;
let currentMonth = new Date().toISOString().slice(0,7);
let compareMonth = "";

/* -------------------- ØªØ±Ø¬Ù…Ø§Øª (Ø¹Ø±Ø¨ÙŠ/English) -------------------- */
const L = {
  ar: {
    app_title:"Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ø´Ù‡Ø±ÙŠ",
    cloud_local_only:"ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙÙ‚Ø·",
    cloud_on:"Ù…Ø±ØªØ¨Ø· Ø¨Ø§Ù„Ø³Ø­Ø§Ø¨Ø©",
    cloud_saved_ok:"ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©",
    cloud_error:"ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³Ø­Ø§Ø¨Ø©",
    cloud_error_long:"ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³Ø­Ø§Ø¨Ø©. ØªØ£ÙƒØ¯ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø³ÙƒØ±Ø¨Øª ÙˆØ§Ù„Ø±Ø§Ø¨Ø· Ø«Ù… Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.",
    save_cloud:"Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©",
    load_cloud:"Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©",
    import:"Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª",
    print:"Ø·Ø¨Ø§Ø¹Ø©",
    branches:"Ø§Ù„ÙØ±ÙˆØ¹",
    add_branch:"Ø¥Ø¶Ø§ÙØ© ÙØ±Ø¹",
    admin_dist_settings:"Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ",
    admin_hint:"* Ø§Ù„ÙØ±ÙˆØ¹ Ø§Ù„Ù…ÙØ¹Ù‘ÙÙ„Ø© ÙÙ‚Ø· ØªØªØ­Ù…Ù„ Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ Ø§Ù„Ù…Ù‚Ø³Ù‘Ø· Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± â€œØªÙˆØ²ÙŠØ¹ Ø¹Ù„Ù‰ Ø§Ù„ÙØ±ÙˆØ¹â€.",
    wipe_all:"Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª",
    confirm_wipe:"Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹.",
    report_month:"Ø´Ù‡Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ±",
    compare_with:"Ù…Ù‚Ø§Ø±Ù†Ø© Ù…Ø¹",
    copy_from_cmp:"Ù†Ø³Ø® Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ù‚Ø§Ø±ÙÙ†",
    add_installment:"Ù…ØµØ±ÙˆÙ Ù…Ù‚Ø³Ù‘Ø·",
    income:"Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª",
    operating_exp:"Ù…ØµØ±ÙˆÙØ§Øª ØªØ´ØºÙŠÙ„",
    admin_exp:"Ù…ØµØ±ÙˆÙØ§Øª Ø¥Ø¯Ø§Ø±ÙŠØ©",
    add_item:"Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯",
    col_item:"Ø§Ù„Ø¨Ù†Ø¯",
    col_amount:"Ø§Ù„Ù…Ø¨Ù„Øº",
    actions:"Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª",
    sum_income:"Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª",
    sum_operating:"Ù…Ø¬Ù…ÙˆØ¹ Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ØªØ´ØºÙŠÙ„",
    sum_admin:"Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©",
    summary:"Ø§Ù„Ù…Ù„Ø®Øµ",
    sum_expenses:"Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª",
    profit:"Ø§Ù„Ø±Ø¨Ø­",
    margin:"Ù†Ø³Ø¨Ø© Ø§Ù„Ø±Ø¨Ø­",
    compare_with_month:"Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ù…Ø¹",
    delta_amount:"ÙØ±Ù‚ Ø§Ù„Ù…Ø¨Ù„Øº",
    delta_pct:"ÙØ±Ù‚ Ø§Ù„Ù†Ø³Ø¨Ø©",
    item_name:"Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ø¯",
    section:"Ø§Ù„Ù‚Ø³Ù…",
    total_amount:"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº",
    months_count:"Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ù‡Ø±",
    start_month:"Ø´Ù‡Ø± Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©",
    scope:"Ø§Ù„Ù†Ø·Ø§Ù‚",
    scope_single:"Ù‡Ø°Ø§ Ø§Ù„ÙØ±Ø¹ ÙÙ‚Ø·",
    scope_weighted:"ØªÙˆØ²ÙŠØ¹ Ø¹Ù„Ù‰ Ø§Ù„ÙØ±ÙˆØ¹ Ø­Ø³Ø¨ Ø§Ù„Ø£ÙˆØ²Ø§Ù†",
    inst_hint:"Ø³ÙŠÙØ­Ù…Ù‘ÙÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ ÙƒÙ„ Ø´Ù‡Ø±: (Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ã· Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ù‡Ø±). ÙˆØ¥Ø°Ø§ Ø§Ø®ØªØ±Øª â€œØªÙˆØ²ÙŠØ¹ Ø¹Ù„Ù‰ Ø§Ù„ÙØ±ÙˆØ¹â€ ÙØ³ÙŠÙÙ‚Ø³Ù‘ÙÙ… Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø´Ù‡Ø±ÙŠ Ø­Ø³Ø¨ Ø£ÙˆØ²Ø§Ù† Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ù„Ù„ÙØ±ÙˆØ¹ Ø§Ù„Ù…ÙØ¹Ù‘Ù„Ø©.",
    cancel:"Ø¥Ù„ØºØ§Ø¡",
    save:"Ø­ÙØ¸",
    rename:"ØªØ¹Ø¯ÙŠÙ„",
    delete:"Ø­Ø°Ù",
    item_new:"Ø¨Ù†Ø¯ Ø¬Ø¯ÙŠØ¯",
    pick_cmp_first:"Ø§Ø®ØªØ± Ø´Ù‡Ø± Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ø£ÙˆÙ„Ø§Ù‹.",
    confirm_copy:"Ù†Ø³Ø® Ø§Ù„Ø¨Ù†ÙˆØ¯ Ù…Ù† Ø´Ù‡Ø± Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ø¥Ù„Ù‰ Ø´Ù‡Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ± (Ù„Ù† ÙŠÙØ³ØªØ¨Ø¯Ù„ Ø§Ù„Ù…Ù‚Ø³Ù‘Ø·)ØŸ",
    invalid_file:"Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­"
  },
  en: {
    app_title:"Monthly Profit Manager",
    cloud_local_only:"Local-only save",
    cloud_on:"Cloud connected",
    cloud_saved_ok:"Saved to cloud",
    cloud_error:"Cloud connection failed",
    cloud_error_long:"Could not reach the cloud. Check Apps Script permissions/URL and try again.",
    save_cloud:"Save to Cloud",
    load_cloud:"Load from Cloud",
    import:"Import",
    print:"Print",
    branches:"Branches",
    add_branch:"Add Branch",
    admin_dist_settings:"Admin Overhead Distribution",
    admin_hint:"* Only enabled branches share admin overhead when â€œdistribute across branchesâ€ is selected.",
    wipe_all:"Wipe all data",
    confirm_wipe:"Are you sure you want to wipe all data? This cannot be undone.",
    report_month:"Report Month",
    compare_with:"Compare With",
    copy_from_cmp:"Copy items from comparison month",
    add_installment:"Installment Expense",
    income:"Revenue",
    operating_exp:"Operating Expenses",
    admin_exp:"Administrative Expenses",
    add_item:"Add Item",
    col_item:"Item",
    col_amount:"Amount",
    actions:"Actions",
    sum_income:"Total Revenue",
    sum_operating:"Total Operating",
    sum_admin:"Total Administrative",
    summary:"Summary",
    sum_expenses:"Total Expenses",
    profit:"Profit",
    margin:"Profit Margin",
    compare_with_month:"Compare with",
    delta_amount:"Î” Amount",
    delta_pct:"Î” Margin",
    item_name:"Item Name",
    section:"Section",
    total_amount:"Total Amount",
    months_count:"Months",
    start_month:"Start Month",
    scope:"Scope",
    scope_single:"This branch only",
    scope_weighted:"Distribute by branch weights",
    inst_hint:"The monthly charge is (total Ã· months). If distributed, the monthly share is split by active branch weights.",
    cancel:"Cancel",
    save:"Save",
    rename:"Rename",
    delete:"Delete",
    item_new:"New item",
    pick_cmp_first:"Select the comparison month first.",
    confirm_copy:"Copy items from the comparison month into the report month (installments remain auto)?",
    invalid_file:"Invalid file"
  }
};
function t(key){ return L[DB.lang]?.[key] || key; }
function applyI18n(){
  document.documentElement.lang = DB.lang;
  document.documentElement.dir  = (DB.lang==='ar')?'rtl':'ltr';
  // Ø§Ù„Ù†ØµÙˆØµ
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    el.textContent = t(el.getAttribute('data-i18n'));
  });
  // Ø²Ø± Ø§Ù„Ù„ØºØ©
  document.getElementById('langBtn').textContent = (DB.lang==='ar')?'Ø¹Ø±Ø¨ÙŠ / EN':'EN / Ø¹Ø±Ø¨ÙŠ';
  // ØªØ­Ø¯ÙŠØ« Ø¹Ù†Ø§ÙˆÙŠÙ† Ùˆ placeholders Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø¥Ù† Ù„Ø²Ù…
}

/* -------------------- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ÙØ±ÙˆØ¹ ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -------------------- */
function renderBranches(){
  const list = document.getElementById('branchList');
  list.innerHTML = "";
  DB.branches.forEach(b=>{
    const a = document.createElement('a');
    a.href="#"; a.className="list-group-item d-flex align-items-center justify-content-between";
    if(b.id===currentBranchId) a.classList.add('active');
    a.innerHTML = `<span>${b.name}</span>
      <span class="no-print d-flex gap-1">
        <button class="btn btn-sm btn-outline-secondary" onclick="renameBranch('${b.id}')">${t('rename')}</button>
        <button class="btn btn-sm btn-outline-danger" onclick="delBranch('${b.id}')">${t('delete')}</button>
      </span>`;
    a.onclick=(e)=>{e.preventDefault(); currentBranchId=b.id; renderPage();}
    list.appendChild(a);
  });

  // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£ÙˆØ²Ø§Ù† ÙˆØ§Ù„Ø¥Ø¯Ø§Ø±ÙŠ
  const box = document.getElementById('adminSettings'); box.innerHTML="";
  DB.branches.forEach(b=>{
    const row = document.createElement('div');
    row.className="d-flex align-items-center gap-2";
    row.innerHTML = `
      <input type="checkbox" class="form-check-input" ${b.includeAdmin?'checked':''}
        onchange="bToggleAdmin('${b.id}',this.checked)">
      <span class="me-1" style="width:140px">${b.name}</span>
      <input type="number" class="form-control form-control-sm" style="width:90px"
        value="${b.weight}" min="0" step="0.1" onchange="bSetWeight('${b.id}',this.value)">
      <span class="muted">${DB.lang==='ar'?'ÙˆØ²Ù†':'Weight'}</span>`;
    box.appendChild(row);
  });
}
function bToggleAdmin(id, val){ const b=DB.branches.find(x=>x.id===id); if(b){b.includeAdmin=!!val; save();} }
function bSetWeight(id, v){ const b=DB.branches.find(x=>x.id===id); if(b){b.weight=parseFloat(v)||0; save();} }
function addBranch(){
  const name=prompt(DB.lang==='ar'?'Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯ØŸ':'New branch name?',"");
  if(!name) return;
  DB.branches.push({id:cid(), name, active:true, weight:1, includeAdmin:true});
  save(); renderBranches();
}
function renameBranch(id){
  const b=DB.branches.find(x=>x.id===id); if(!b) return;
  const name=prompt(DB.lang==='ar'?'Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:':'New name:', b.name); if(!name) return;
  b.name=name; save(); renderBranches(); renderPage();
}
function delBranch(id){
  if(!confirm(DB.lang==='ar'?'Ø­Ø°Ù Ø§Ù„ÙØ±Ø¹ ÙˆØ¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ØŸ':'Delete branch and all its data?')) return;
  DB.branches = DB.branches.filter(x=>x.id!==id);
  for(const m in DB.months){ if(DB.months[m][id]) delete DB.months[m][id]; }
  DB.installments = DB.installments.filter(i=>i.branchId!==id);
  if(currentBranchId===id) currentBranchId = DB.branches[0]?.id || null;
  save(); renderBranches(); renderPage();
}

/* -------------------- ØµÙØ­Ø© Ø§Ù„ÙØ±Ø¹ -------------------- */
function ensureMonthBranch(mm, bid){
  DB.months[mm] = DB.months[mm] || {};
  DB.months[mm][bid] = DB.months[mm][bid] || {income:[], operating:[], admin:[]};
  return DB.months[mm][bid];
}
function renderPage(){
  if(!currentBranchId){ document.getElementById('branchTitle').textContent="â€”"; return; }
  document.getElementById('branchTitle').textContent =
    DB.branches.find(b=>b.id===currentBranchId)?.name || "â€”";
  const mCur = document.getElementById('monthCurrent'); mCur.value = currentMonth;
  const mCmp = document.getElementById('monthCompare'); mCmp.value = compareMonth;

  renderBranches(); // Ù„ØªØ­Ø¯ÙŠØ« ØªÙ…ÙŠÙŠØ² Ø§Ù„ÙØ±Ø¹
  renderTable('income'); renderTable('operating'); renderTable('admin');
  updateSummary();
}
document.getElementById('monthCurrent').addEventListener('change', (e)=>{ currentMonth=e.target.value; renderPage(); });
document.getElementById('monthCompare').addEventListener('change', (e)=>{ compareMonth=e.target.value; updateSummary(); });

function addRow(section){
  const rows = ensureMonthBranch(currentMonth, currentBranchId)[section];
  rows.push({name:t('item_new'), amount:0});
  save(); renderTable(section); updateSummary();
}
function delRow(section, idx){
  ensureMonthBranch(currentMonth, currentBranchId)[section].splice(idx,1);
  save(); renderTable(section); updateSummary();
}
function renderTable(section){
  const tbody = document.getElementById('tbl-'+section); tbody.innerHTML="";
  const rows = ensureMonthBranch(currentMonth, currentBranchId)[section];

  // Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ù…Ù‚Ø³Ø·Ø© ÙŠØªÙ… Ø­Ù‚Ù†Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ (ØºÙŠØ± Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„/Ø§Ù„Ø­Ø°Ù)
  const autoRows = calcInstallmentsFor(currentMonth, currentBranchId, section)
    .map(x=>({name:`( ${DB.lang==='ar'?'Ù…Ù‚Ø³Ù‘Ø·':'Installment'} ) ${x.name}`, amount:x.amount, _auto:true}));
  const all = rows.concat(autoRows);

  all.forEach((r, i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r._auto ? r.name : `<input type="text" value="${r.name}" oninput="editCell('${section}',${i},'name',this.value)">`}</td>
      <td>${r._auto ? numberFmt(r.amount) : `<input type="number" value="${r.amount}" oninput="editCell('${section}',${i},'amount',this.value)">`}</td>
      <td class="no-print">${r._auto ? '<span class="text-muted">â€”</span>' : `<button class="btn btn-sm btn-outline-danger" onclick="delRow('${section}',${i})">${t('delete')}</button>`}</td>`;
    tbody.appendChild(tr);
  });

  document.getElementById('sum-'+section).textContent = numberFmt(sumRows(all));
}
function editCell(section, idx, field, val){
  const rows = ensureMonthBranch(currentMonth, currentBranchId)[section];
  if(!rows[idx]) return;
  rows[idx][field] = field==='amount' ? (parseFloat(val)||0) : val;
  save(); updateSummary();
}
function sumRows(rows){ return rows.reduce((s,r)=> s + (+r.amount||0), 0); }
function numberFmt(n){
  const loc = (DB.lang==='ar')?'ar-EG':'en-US';
  return (+n||0).toLocaleString(loc, {maximumFractionDigits:2});
}

/* -------------------- Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù…Ù‚Ø³Ø·Ø© -------------------- */
const instModal = new bootstrap.Modal('#installmentModal');
function openInstallment(){
  document.getElementById('inst-name').value="";
  document.getElementById('inst-total').value=0;
  document.getElementById('inst-months').value=3;
  document.getElementById('inst-section').value='operating';
  document.getElementById('inst-start').value = currentMonth;
  document.getElementById('inst-scope').value='single';
  instModal.show();
}
function saveInstallment(){
  const name = document.getElementById('inst-name').value.trim();
  const total = parseFloat(document.getElementById('inst-total').value)||0;
  const months = Math.max(1, parseInt(document.getElementById('inst-months').value)||1);
  const start = document.getElementById('inst-start').value;
  const section = document.getElementById('inst-section').value;
  const scope = document.getElementById('inst-scope').value;
  if(!name || !start){ alert(DB.lang==='ar'?'Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„.':'Please complete the fields.'); return; }
  DB.installments.push({
    id: cid(), name, total, months, start, section,
    scope, branchId: currentBranchId, created: new Date().toISOString()
  });
  save(); instModal.hide(); renderTable(section); updateSummary();
}
function monthAdd(ym, k){
  const [y,m]=ym.split('-').map(Number);
  const d=new Date(y, m-1+k, 1);
  return d.toISOString().slice(0,7);
}
function calcInstallmentsFor(ym, bid, section){
  const perMonth = [];
  DB.installments.forEach(ins=>{
    if(ins.section!==section) return;
    const end = monthAdd(ins.start, ins.months-1);
    if(ym < ins.start || ym > end) return;

    const mAmount = ins.total / ins.months;
    if(ins.scope==='single'){
      if(ins.branchId===bid) perMonth.push({name:ins.name, amount:mAmount});
    }else{
      // ØªÙˆØ²ÙŠØ¹ Ø¨Ø§Ù„ÙˆØ²Ù†ØŒ Ù…Ø¹ Ù‚ÙŠØ¯ Ø´Ù…ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ ÙÙ‚Ø· Ù„Ù…Ù† Ù…ÙÙØ¹Ù‘Ù„ Ù„Ø¯ÙŠÙ‡ includeAdmin
      const eligible = DB.branches.filter(b=>{
        if(section==='admin') return b.includeAdmin;
        return true;
      });
      const weights = eligible.reduce((s,b)=> s+(+b.weight||0), 0) || 1;
      const b = DB.branches.find(x=>x.id===bid);
      const w = eligible.find(x=>x.id===bid) ? ((+b.weight||0)/weights) : 0;
      perMonth.push({name:ins.name, amount: mAmount * w});
    }
  });
  return perMonth;
}

/* -------------------- Ø§Ù„Ù…Ù„Ø®Øµ ÙˆØ§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© -------------------- */
function computeTotals(month, bid){
  const incRows = ensureMonthBranch(month, bid)['income'].concat(
    calcInstallmentsFor(month, bid, 'income') // Ø§Ø­ØªÙŠØ§Ø·ÙŠÙ‹Ø§ Ù„Ùˆ Ø§Ø­ØªØ¬ØªÙ‡ Ù…Ø³ØªÙ‚Ø¨Ù„Ø§Ù‹
  );
  const opRows  = ensureMonthBranch(month, bid)['operating'].concat(
    calcInstallmentsFor(month, bid, 'operating')
  );
  const adRows  = ensureMonthBranch(month, bid)['admin'].concat(
    calcInstallmentsFor(month, bid, 'admin')
  );

  const inc = sumRows(incRows);
  const op  = sumRows(opRows);
  const ad  = sumRows(adRows);
  const exp = op + ad;
  const profit = inc - exp;
  const margin = inc>0 ? (profit/inc*100) : 0;
  return {inc, op, ad, exp, profit, margin};
}
function updateSummary(){
  const tts = computeTotals(currentMonth, currentBranchId);
  document.getElementById('s-inc').textContent = numberFmt(tts.inc);
  document.getElementById('s-exp').textContent = numberFmt(tts.exp);
  const p = document.getElementById('s-profit');
  p.textContent = numberFmt(tts.profit);
  p.className = tts.profit>=0 ? 'profit-pos' : 'profit-neg';
  document.getElementById('s-margin').textContent = (tts.margin||0).toFixed(2)+'%';

  let deltaAmt=0, deltaPct=0;
  if(compareMonth){
    const c = computeTotals(compareMonth, currentBranchId);
    deltaAmt = tts.profit - c.profit;
    const pctA = tts.inc>0 ? (tts.profit/tts.inc*100) : 0;
    const pctB = c.inc>0 ? (c.profit/c.inc*100) : 0;
    deltaPct = pctA - pctB;
    document.getElementById('cmp-month').textContent = compareMonth;
  }else{
    document.getElementById('cmp-month').textContent = 'â€”';
  }
  document.getElementById('cmp-amt').textContent = numberFmt(deltaAmt);
  document.getElementById('cmp-pct').textContent = (deltaPct||0).toFixed(2)+'%';

  // ØªØ­Ø¯ÙŠØ« Ù…Ø¬Ø§Ù…ÙŠØ¹ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ (ØªØ´Ù…Ù„ Ø§Ù„Ù…Ù‚Ø³Ù‘Ø·)
  document.getElementById('sum-income').textContent   = numberFmt(tts.inc);
  document.getElementById('sum-operating').textContent= numberFmt(tts.op);
  document.getElementById('sum-admin').textContent    = numberFmt(tts.ad);
}

/* -------------------- Ù†Ø³Ø® Ù…Ù† Ø´Ù‡Ø± Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© -------------------- */
function copyFromPrevious(){
  if(!compareMonth){ alert(t('pick_cmp_first')); return; }
  if(!confirm(t('confirm_copy'))) return;
  const src = ensureMonthBranch(compareMonth, currentBranchId);
  const dst = ensureMonthBranch(currentMonth, currentBranchId);
  ['income','operating','admin'].forEach(sec=>{
    dst[sec] = JSON.parse(JSON.stringify(src[sec]||[]));
  });
  save(); renderTable('income'); renderTable('operating'); renderTable('admin'); updateSummary();
}

/* -------------------- Ø§Ø³ØªÙŠØ±Ø§Ø¯/ØªØµØ¯ÙŠØ± -------------------- */
function exportJSON(){
  const blob = new Blob([JSON.stringify(DB, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url; a.download='profit-data.json'; a.click();
  URL.revokeObjectURL(url);
}
document.getElementById('importFile').addEventListener('change', (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = () => { try{ DB = JSON.parse(r.result); save(); location.reload(); } catch{ alert(t('invalid_file')); } };
  r.readAsText(f);
});
function exportExcel(){
  const wb = XLSX.utils.book_new();
  const months = Object.keys(DB.months).sort();
  if(months.length===0){ alert(DB.lang==='ar'?'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª.':'No data.'); return; }
  months.forEach(mm=>{
    DB.branches.forEach(b=>{
      if(!DB.months[mm][b.id]) return;
      const t = computeTotals(mm, b.id);
      const rows = [
        [DB.lang==='ar'?'Ø§Ù„ÙØ±Ø¹':'Branch', b.name],
        [DB.lang==='ar'?'Ø§Ù„Ø´Ù‡Ø±':'Month', mm], [],
        [tLabel('income')],[t('col_item'), t('col_amount')]
      ];
      (DB.months[mm][b.id].income || []).forEach(r=> rows.push([r.name, r.amount]));
      rows.push([DB.lang==='ar'?'(Ù…Ù‚Ø³Ù‘Ø·) â€” Ù…Ø­Ø³ÙˆØ¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹':'(Installments) â€” auto', ""]);
      rows.push([t('sum_income'), t.inc]); rows.push([]);
      rows.push([t('operating_exp')],[t('col_item'),t('col_amount')]);
      (DB.months[mm][b.id].operating || []).forEach(r=> rows.push([r.name, r.amount]));
      rows.push([DB.lang==='ar'?'(ÙŠØ´Ù…Ù„ Ø§Ù„Ù…Ù‚Ø³Ù‘Ø· Ø§Ù„Ø´Ù‡Ø±ÙŠ)':'(includes monthly installments)', ""]);
      rows.push([t('sum_operating'), t.op]); rows.push([]);
      rows.push([t('admin_exp')],[t('col_item'),t('col_amount')]);
      (DB.months[mm][b.id].admin || []).forEach(r=> rows.push([r.name, r.amount]));
      rows.push([DB.lang==='ar'?'(ÙŠØ´Ù…Ù„ Ø§Ù„Ù…Ù‚Ø³Ù‘Ø· Ø§Ù„Ø´Ù‡Ø±ÙŠ)':'(includes monthly installments)', ""]);
      rows.push([t('sum_admin'), t.ad]); rows.push([]);
      rows.push([t('profit'), t.profit]);
      rows.push([t('margin'), (t.margin||0).toFixed ? (t.margin||0).toFixed(2)+"%" : t.margin+"%"]);

      const ws = XLSX.utils.aoa_to_sheet(rows);
      XLSX.utils.book_append_sheet(wb, ws, `${b.name}-${mm}`);
    });
  });
  XLSX.writeFile(wb, (DB.lang==='ar'?"ØªÙ‚Ø§Ø±ÙŠØ±-Ø§Ù„Ø£Ø±Ø¨Ø§Ø­":"Profit-Reports")+".xlsx");
}
function tLabel(sectionKey){
  if(sectionKey==='income') return t('income');
  if(sectionKey==='operating') return t('operating_exp');
  if(sectionKey==='admin') return t('admin_exp');
  return sectionKey;
}

/* -------------------- Ù„ØºØ© / Ø£Ø²Ø±Ø§Ø± Ø³Ø­Ø§Ø¨Ø© -------------------- */
document.getElementById('langBtn').addEventListener('click', ()=>{
  DB.lang = (DB.lang==='ar'?'en':'ar'); save(); applyI18n(); renderBranches(); renderPage();
});
document.getElementById('btnCloudSave').addEventListener('click', cloudSave);
document.getElementById('btnCloudLoad').addEventListener('click', cloudLoad);

/* -------------------- ØªÙ‡ÙŠØ¦Ø© -------------------- */
(function init(){
  currentMonth = new Date().toISOString().slice(0,7);
  compareMonth = "";
  applyI18n();
  setCloudState(false, t('cloud_local_only'));   // Ø­Ø§Ù„Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©Ø› Ø³ØªØªØºÙŠØ± Ø¨Ø¹Ø¯ Ø£ÙˆÙ„ Ø­ÙØ¸ Ù†Ø§Ø¬Ø­
  renderBranches();
  renderPage();
})();
</script>
</body>
</html>
