<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>برنامج الأرباح الشهري — تسجيل ودخول آمن</title>

<!-- Bootstrap RTL -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet"/>

<!-- SheetJS (إن كنت تصدّر Excel/JSON لاحقاً) -->
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<style>
:root{ --brand:#0d47a1; --muted:#6c757d; }
body{ background:#fff; color:#222; }
.navbar{ background:var(--brand); }
.navbar .navbar-brand,.navbar .btn,.navbar .nav-link{ color:#fff; }
.navbar .btn.btn-light{ color:var(--brand); }
.card{ box-shadow:0 2px 10px rgba(0,0,0,.05); border:1px solid #eef1f4; }
.badge-soft{background:#eef2ff;color:#2b3a67;border:1px solid #dfe7ff}
.pill{padding:.35rem .6rem;border-radius:1rem;border:1px solid #e5e8ee;background:#fff}
.muted{ color:var(--muted); }

#auth-view{ max-width:420px; margin:7vh auto; }
.auth-logo{ font-size:2rem; color:var(--brand); }
.auth-hint{ font-size:.9rem; color:#6b7280; }
.link{ cursor:pointer; color:#0d6efd; text-decoration:underline; }

@media (max-width: 576px){
  .navbar-brand{ font-size:1rem; }
}
</style>
</head>
<body>

<!-- شريط علوي -->
<nav class="navbar navbar-expand-lg">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="#">📊 برنامج الأرباح الشهري</a>
    <div class="ms-auto d-flex align-items-center gap-2">
      <div class="btn-group" role="group" aria-label="lang">
        <button id="btn-ar" class="btn btn-light btn-sm">العربية</button>
        <button id="btn-en" class="btn btn-outline-light btn-sm">English</button>
      </div>
      <button id="btn-signout" class="btn btn-light btn-sm d-none">🚪 <span data-i18n="signout">تسجيل خروج</span></button>
    </div>
  </div>
</nav>

<!-- شاشة الدخول -->
<section id="auth-view" class="container">
  <div class="card">
    <div class="card-body p-4">
      <div class="text-center mb-3">
        <div class="auth-logo">🔐</div>
        <h5 class="mt-2" data-i18n="signinTitle">تسجيل الدخول</h5>
        <div class="auth-hint" data-i18n="signinHint">ادخل بريدك وكلمة المرور للمتابعة.</div>
      </div>

      <div class="vstack gap-2">
        <label class="form-label" data-i18n="email">البريد الإلكتروني</label>
        <input id="auth-email" type="email" class="form-control" placeholder="name@example.com" autocomplete="username" />
        <label class="form-label mt-2" data-i18n="password">كلمة المرور</label>
        <input id="auth-pass" type="password" class="form-control" placeholder="••••••••" autocomplete="current-password" />
      </div>

      <div class="d-grid gap-2 mt-3">
        <button id="btn-login" class="btn btn-primary"><span data-i18n="signinBtn">دخول</span></button>
        <button id="btn-register" class="btn btn-outline-primary"><span data-i18n="signupBtn">إنشاء حساب جديد</span></button>
      </div>

      <div id="auth-error" class="text-danger small mt-3" style="display:none"></div>

      <div class="text-center mt-3">
        <span class="auth-hint" data-i18n="firstTime">
          أول مرة تستخدم السحابة؟ اضغط “إنشاء حساب جديد”، ثم سجّل الدخول.
        </span>
      </div>
    </div>
  </div>
</section>

<!-- الواجهة بعد تسجيل الدخول -->
<section id="app-view" class="container-fluid" style="display:none">
  <div class="row g-3 p-3">
    <div class="col-12 d-flex align-items-center gap-2 flex-wrap">
      <span class="pill"><span class="muted" data-i18n="state">الحالة</span>:
        <b id="login-state" class="text-success">—</b>
      </span>
      <span class="pill"><span class="muted" data-i18n="user">المستخدم</span>:
        <b id="login-user">—</b>
      </span>
      <div class="ms-auto d-flex gap-2">
        <button class="btn btn-outline-success btn-sm" id="btn-save-cloud">☁️ <span data-i18n="saveCloud">حفظ سحابي</span></button>
        <button class="btn btn-outline-secondary btn-sm" id="btn-load-cloud">☁️ <span data-i18n="loadCloud">تحميل سحابي</span></button>
      </div>
    </div>

    <!-- ضع برنامجك الكامل هنا كما هو بدون تغيير -->
    <div class="col-12">
      <div class="card">
        <div class="card-header d-flex align-items-center justify-content-between">
          <span>📒 <b data-i18n="yourApp">برنامجك</b></span>
          <span class="text-muted small" data-i18n="yourAppHint">ضع هنا كود الواجهة الحالي (الجداول/الأقسام/الحسابات…)</span>
        </div>
        <div class="card-body" id="your-app">
          <!-- ⬅️⬅️⬅️  الصق هنا واجهتك الحالية (التي تصل ~1000 سطر)  ⬅️⬅️⬅️
               لن تحتاج لتعديل أي شيء بداخلها. فقط تأكد أن لديك كائن بياناتك DB
               أو غيّر الدوال saveLocal()/renderPage() أدناه لتناسبك. -->
          <div class="alert alert-info m-0">
            <div data-i18n="placeholder">
              هذه مجرد مساحة مؤقتة للشرح. الصق واجهتك الحالية هنا ليعمل كل شيء كما كان،
              لكن مع تسجيل الدخول الآمن وحفظ/تحميل سحابي لكل مستخدم.
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</section>

<!-- Firebase SDKs -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

  // ✅ إعداد مشروعك (نفس الذي استخدمته من قبل)
  const firebaseConfig = {
    apiKey: "AIzaSyDgtifnouF0AGzBxWls3wPk7gikSqOBFm0",
    authDomain: "monthly-prfits.firebaseapp.com",
    projectId: "monthly-prfits",
    storageBucket: "monthly-prfits.firebasestorage.app",
    messagingSenderId: "896730662080",
    appId: "1:896730662080:web:a41850c6736ab6b02d1925",
    measurementId: "G-KX9KFLVV3J"
  };

  // ✅ تهيئة الخدمات
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  // ----------------- i18n بسيط (عربي/إنجليزي) -----------------
  const I18N = {
    ar: {
      signout:"تسجيل خروج",
      signinTitle:"تسجيل الدخول",
      signinHint:"ادخل بريدك وكلمة المرور للمتابعة.",
      email:"البريد الإلكتروني",
      password:"كلمة المرور",
      signinBtn:"دخول",
      signupBtn:"إنشاء حساب جديد",
      firstTime:"أول مرة تستخدم السحابة؟ اضغط “إنشاء حساب جديد”، ثم سجّل الدخول.",
      state:"الحالة",
      user:"المستخدم",
      saveCloud:"حفظ سحابي",
      loadCloud:"تحميل سحابي",
      yourApp:"الواجهة",
      yourAppHint:"ضع هنا كود الواجهة الحالي (الجداول/الأقسام/الحسابات…)",
      placeholder:"هذه مجرد مساحة مؤقتة للشرح. الصق واجهتك الحالية هنا ليعمل كل شيء كما كان، لكن مع تسجيل الدخول الآمن وحفظ/تحميل سحابي لكل مستخدم.",
      signedIn:"متصل",
      signedOut:"غير متصل",
      savedOk:"✅ تم الحفظ في السحابة",
      savedErr:"❌ خطأ في الحفظ بالسحابة",
      loadedOk:"✅ تم التحميل من السحابة",
      loadedEmpty:"⚠️ لا توجد بيانات سحابية بعد",
      loadedErr:"❌ خطأ في تحميل البيانات",
    },
    en: {
      signout:"Sign out",
      signinTitle:"Sign in",
      signinHint:"Enter your email and password to continue.",
      email:"Email",
      password:"Password",
      signinBtn:"Sign in",
      signupBtn:"Create new account",
      firstTime:"First time? Click “Create new account”, then sign in.",
      state:"Status",
      user:"User",
      saveCloud:"Save to Cloud",
      loadCloud:"Load from Cloud",
      yourApp:"Your App",
      yourAppHint:"Paste your existing UI here (tables/sections/calculations…)",
      placeholder:"Temporary placeholder. Paste your existing UI so everything works as before, with secure login and per-user cloud storage.",
      signedIn:"Online",
      signedOut:"Offline",
      savedOk:"✅ Saved to cloud",
      savedErr:"❌ Cloud save failed",
      loadedOk:"✅ Loaded from cloud",
      loadedEmpty:"⚠️ No cloud data yet",
      loadedErr:"❌ Cloud load failed",
    }
  };
  let LANG = 'ar';
  function t(k){ return (I18N[LANG]||{})[k] || k; }
  function applyLang(){
    document.documentElement.lang = LANG;
    document.documentElement.dir = LANG==='ar'?'rtl':'ltr';
    document.querySelectorAll('[data-i18n]').forEach(el=>{
      const key = el.getAttribute('data-i18n');
      el.textContent = t(key);
    });
    // تحديث الحالات النصية
    document.getElementById('login-state').textContent =
      auth.currentUser ? t('signedIn') : t('signedOut');
  }
  document.getElementById('btn-ar').onclick=()=>{
    LANG='ar';
    document.getElementById('btn-ar').className='btn btn-light btn-sm';
    document.getElementById('btn-en').className='btn btn-outline-light btn-sm';
    applyLang();
  };
  document.getElementById('btn-en').onclick=()=>{
    LANG='en';
    document.getElementById('btn-en').className='btn btn-light btn-sm';
    document.getElementById('btn-ar').className='btn btn-outline-light btn-sm';
    applyLang();
  };

  // ----------------- بياناتك المحلية (DB) -----------------
  // ملاحظة: إن كان لديك كائن DB جاهز في واجهتك القديمة، اتركه كما هو.
  // هنا نضع افتراضي بسيط لتجارب الحفظ/التحميل:
  const STORE_KEY = "profit_manager_v3";
  function loadLocal(){
    try{ return JSON.parse(localStorage.getItem(STORE_KEY) || "{}"); }
    catch{ return {}; }
  }
  function saveLocal(obj){
    localStorage.setItem(STORE_KEY, JSON.stringify(obj||DB));
  }
  // إن كان لديك DB سابق فاستبدل هذا:
  let DB = loadLocal();

  // ----------------- Firestore (حفظ/تحميل لكل مستخدم) -----------------
  async function saveToCloud(){
    if(!auth.currentUser){ alert(t('savedErr')); return; }
    try{
      const payload = { content: JSON.stringify(DB), updatedAt: new Date().toISOString() };
      const ref = doc(db, "users", auth.currentUser.uid, "profits", "main");
      await setDoc(ref, payload, { merge:true });
      alert(t('savedOk'));
    }catch(e){
      console.error(e); alert(t('savedErr'));
    }
  }
  async function loadFromCloud(){
    if(!auth.currentUser){ alert(t('loadedErr')); return; }
    try{
      const ref = doc(db, "users", auth.currentUser.uid, "profits", "main");
      const snap = await getDoc(ref);
      if(snap.exists()){
        const raw = snap.data().content;
        DB = JSON.parse(raw||"{}");
        saveLocal(DB);
        // إذا كانت لديك دالة renderPage() في واجهتك، استدعها:
        if(typeof window.renderPage === 'function') window.renderPage();
        alert(t('loadedOk'));
      }else{
        alert(t('loadedEmpty'));
      }
    }catch(e){
      console.error(e); alert(t('loadedErr'));
    }
  }

  // ربط الأزرار
  document.getElementById('btn-save-cloud').onclick=saveToCloud;
  document.getElementById('btn-load-cloud').onclick=loadFromCloud;

  // ----------------- Auth: تسجيل/دخول/خروج -----------------
  const $email = document.getElementById('auth-email');
  const $pass  = document.getElementById('auth-pass');
  const $err   = document.getElementById('auth-error');

  async function doLogin(){
    $err.style.display='none';
    try{
      await signInWithEmailAndPassword(auth, $email.value.trim(), $pass.value);
    }catch(e){
      console.error(e);
      $err.textContent = (LANG==='ar'?'فشل تسجيل الدخول: ':'Sign-in failed: ') + (e.message||e.code||'');
      $err.style.display='block';
    }
  }
  async function doRegister(){
    $err.style.display='none';
    try{
      await createUserWithEmailAndPassword(auth, $email.value.trim(), $pass.value);
      // بعد الإنشاء، يصبح المستخدم مسجلاً تلقائياً
    }catch(e){
      console.error(e);
      $err.textContent = (LANG==='ar'?'فشل إنشاء الحساب: ':'Sign-up failed: ') + (e.message||e.code||'');
      $err.style.display='block';
    }
  }
  async function doSignout(){
    await signOut(auth);
  }

  document.getElementById('btn-login').onclick=doLogin;
  document.getElementById('btn-register').onclick=doRegister;
  document.getElementById('btn-signout').onclick=doSignout;

  // تبديل الواجهات حسب حالة الدخول
  onAuthStateChanged(auth, (user)=>{
    const aut = document.getElementById('auth-view');
    const appV= document.getElementById('app-view');
    const signBtn = document.getElementById('btn-signout');
    const uLbl = document.getElementById('login-user');
    const st  = document.getElementById('login-state');

    if(user){
      aut.style.display='none';
      appV.style.display='';
      signBtn.classList.remove('d-none');
      uLbl.textContent = user.email||user.uid;
      st.textContent = t('signedIn');
      st.classList.remove('text-danger'); st.classList.add('text-success');

      // عند أول دخول يمكنك تحميل سحابي تلقائياً (اختياري):
      // loadFromCloud();

      // لو لديك واجهة قديمة تعتمد على init/render:
      if(typeof window.renderPage === 'function') window.renderPage();

    }else{
      aut.style.display='';
      appV.style.display='none';
      signBtn.classList.add('d-none');
      uLbl.textContent = '—';
      st.textContent = t('signedOut');
      st.classList.add('text-danger'); st.classList.remove('text-success');
    }
  });

  // تهيئة اللغة الافتراضية
  (function init(){
    LANG='ar';
    applyLang();
  })();
</script>

<!-- ملاحظة مهمة للأمان (ضعها في قواعد Firestore): 
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{uid}/{document=**} {
      allow read, write: if request.auth != null && request.auth.uid == uid;
    }
  }
}
-->

</body>
</html>
