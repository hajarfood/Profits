<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ø´Ù‡Ø±ÙŠ</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<style>
  :root{ --brand:#0d47a1; --muted:#6c757d; }
  html,body{height:100%}
  body{background:#fff;color:#222}
  .navbar{background:var(--brand)}
  .navbar .navbar-brand,.navbar .nav-link,.navbar .btn{color:#fff}
  .navbar .btn.btn-light{color:var(--brand)}
  .sidebar{min-height:100vh;background:#f8f9fb;border-left:1px solid #e7ebf0}
  .sidebar .list-group-item{border:none;background:transparent}
  .sidebar .list-group-item.active{background:var(--brand);color:#fff;border-radius:.5rem}
  .card{box-shadow:0 2px 10px rgba(0,0,0,.05);border:1px solid #eef1f4}
  .table td input[type="text"], .table td input[type="number"]{width:100%;border:none;background:transparent}
  .table td input:focus{outline:none;border-bottom:1px solid #0d6efd}
  .muted{color:var(--muted)}
  .profit-pos{color:#198754;font-weight:700}
  .profit-neg{color:#dc3545;font-weight:700}
  .section-title{font-weight:700}
  .section-head{cursor:pointer;user-select:none}
  .badge-soft{background:#eef2ff;color:#2b3a67;border:1px solid #dfe7ff}
  .pill{padding:.2rem .5rem;border-radius:1rem;border:1px solid #e5e8ee;background:#fff}
  .login-wrap{min-height:100dvh;display:flex;align-items:center;justify-content:center;background:#f5f7fb}
  .login-card{width:100%;max-width:420px;border:1px solid #eef1f4;box-shadow:0 6px 30px rgba(13,71,161,.12)}
  .role-badge{font-size:.75rem}
  .cursor-default{cursor:default}
  @media print{
    .no-print{display:none!important}
    .sidebar{display:none}
    .container-fluid{padding:0}
    main{width:100%}
    .card{box-shadow:none}
  }
</style>
</head>
<body>

<!-- ============ Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ù†Ø¸ÙŠÙØ©) ============ -->
<div id="loginScreen" class="login-wrap">
  <div class="card login-card p-4">
    <h5 class="text-center mb-3">ğŸ” <span data-i18n="loginTitle">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span></h5>
    <div class="mb-3">
      <label class="form-label" for="loginUser" data-i18n="username">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
      <input id="loginUser" class="form-control" autocomplete="username">
    </div>
    <div class="mb-3">
      <label class="form-label" for="loginPass" data-i18n="password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
      <input id="loginPass" class="form-control" type="password" autocomplete="current-password">
    </div>
    <div class="d-grid gap-2">
      <button class="btn btn-primary" id="btnDoLogin"><span data-i18n="login">Ø¯Ø®ÙˆÙ„</span></button>
    </div>
    <div id="loginMsg" class="text-danger small mt-2" style="min-height:1.25rem"></div>
    <div class="d-flex justify-content-between mt-3">
      <div></div>
      <div class="btn-group" role="group" aria-label="lang">
        <button id="btn-ar" class="btn btn-outline-secondary btn-sm">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
        <button id="btn-en" class="btn btn-outline-secondary btn-sm">English</button>
      </div>
    </div>
  </div>
</div>

<!-- ============ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ============ -->
<nav class="navbar navbar-expand-lg d-none" id="appNavbar">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="#">ğŸ“Š <span data-i18n="appTitle">Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ø´Ù‡Ø±ÙŠ</span></a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMain">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navMain">
      <ul class="navbar-nav me-auto">
        <li class="nav-item">
          <span id="currentRoleBadge" class="badge bg-light text-dark role-badge cursor-default ms-2">â€”</span>
        </li>
      </ul>
      <div class="d-flex gap-2 align-items-center">
        <div class="btn-group no-print" role="group" aria-label="lang">
          <button id="nav-btn-ar" class="btn btn-light btn-sm">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
          <button id="nav-btn-en" class="btn btn-outline-light btn-sm">English</button>
        </div>

        <input type="file" id="importFile" class="d-none" accept=".json" />
        <button class="btn btn-light btn-sm no-print" onclick="document.getElementById('importFile').click()">ğŸ“¥ <span data-i18n="import">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</span></button>
        <button class="btn btn-light btn-sm no-print" onclick="exportJSON()">ğŸ“¤ <span data-i18n="exportJson">ØªØµØ¯ÙŠØ± JSON</span></button>
        <button class="btn btn-light btn-sm no-print" onclick="exportExcel()">ğŸ“Š <span data-i18n="exportExcel">ØªØµØ¯ÙŠØ± Excel</span></button>

        <button id="btnSaveCloud" class="btn btn-light btn-sm no-print" onclick="manualSaveCloud()">â˜ï¸ <span data-i18n="saveCloud">Ø­ÙØ¸ Ø³Ø­Ø§Ø¨ÙŠ</span></button>
        <button id="btnLoadCloud" class="btn btn-light btn-sm no-print" onclick="manualLoadCloud()">â˜ï¸ <span data-i18n="loadCloud">ØªØ­Ù…ÙŠÙ„ Ø³Ø­Ø§Ø¨ÙŠ</span></button>

        <button id="btnUsers" class="btn btn-warning btn-sm no-print d-none" data-bs-toggle="modal" data-bs-target="#usersModal">ğŸ‘¤ <span data-i18n="manageUsers">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span></button>

        <button class="btn btn-outline-light btn-sm no-print" onclick="window.print()">ğŸ–¨ï¸ <span data-i18n="print">Ø·Ø¨Ø§Ø¹Ø©</span></button>
        <button class="btn btn-outline-light btn-sm no-print" onclick="doLogout()">ğŸšª <span data-i18n="logout">Ø®Ø±ÙˆØ¬</span></button>
      </div>
    </div>
  </div>
</nav>

<div id="appShell" class="container-fluid d-none">
  <div class="row g-0">
    <aside class="col-12 col-lg-3 col-xl-2 sidebar p-3">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <h6 class="m-0 text-muted" data-i18n="branches">Ø§Ù„ÙØ±ÙˆØ¹</h6>
      </div>
      <div id="branchList" class="list-group mb-4"></div>

      <div class="mb-3">
        <h6 class="text-muted" data-i18n="adminSettings">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ</h6>
        <div id="adminSettings" class="vstack gap-2"></div>
        <small class="text-muted d-block mt-2" data-i18n="adminHint">
          * Ø§Ù„ÙØ±ÙˆØ¹ Ø§Ù„Ù…ÙØ¹Ù‘ÙÙ„Ø© ÙÙ‚Ø· ØªØªØ­Ù…Ù„ Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ Ø§Ù„Ù…Ù‚Ø³Ù‘Ø· Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± â€œØªÙˆØ²ÙŠØ¹ Ø¹Ù„Ù‰ Ø§Ù„ÙØ±ÙˆØ¹â€.
        </small>
      </div>

      <div class="mt-4 no-print">
        <button class="btn btn-outline-danger btn-sm" onclick="wipeLocalConfirm()">
          <span data-i18n="wipe">Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©</span>
        </button>
      </div>
    </aside>

    <main class="col-12 col-lg-9 col-xl-10 p-3">
      <div class="d-flex align-items-center gap-3 flex-wrap">
        <h4 id="branchTitle" class="m-0">â€”</h4>
        <span class="pill"><span class="muted" data-i18n="reportMonth">Ø´Ù‡Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ±</span>:
          <input type="month" id="monthCurrent" class="form-control form-control-sm d-inline-block" style="width:160px"></span>
        <span class="pill"><span class="muted" data-i18n="compareWith">Ù…Ù‚Ø§Ø±Ù†Ø© Ù…Ø¹</span>:
          <input type="month" id="monthCompare" class="form-control form-control-sm d-inline-block" style="width:160px"></span>
        <button id="btnCopyPrev" class="btn btn-outline-secondary btn-sm no-print" onclick="copyFromPrevious()">
          <span data-i18n="copyFromCmp">Ù†Ø³Ø® Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ù‚Ø§Ø±ÙÙ†</span>
        </button>
        <button id="btnAddInst" class="btn btn-outline-primary btn-sm no-print" onclick="openInstallment()">
          â• <span data-i18n="addInstallment">Ù…ØµØ±ÙˆÙ Ù…Ù‚Ø³Ù‘Ø·</span>
        </button>
        <button id="btnManageInst" class="btn btn-outline-primary btn-sm no-print" onclick="openManageInstallments()">
          âš™ï¸ <span data-i18n="manageInstallments">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‚Ø³Ù‘Ø·</span>
        </button>
      </div>

      <hr/>

      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center section-head" data-bs-toggle="collapse" data-bs-target="#sec-income">
          <span class="section-title">ğŸ’° <span data-i18n="income">Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</span></span>
          <div>
            <span class="badge badge-soft me-2"><span data-i18n="sum">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>: <b id="sum-income">0</b></span>
            <button id="btnAddIncome" class="btn btn-sm btn-outline-primary no-print" onclick="addRow('income')">â• <span data-i18n="addRow">Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯</span></button>
          </div>
        </div>
        <div id="sec-income" class="collapse show">
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-bordered m-0">
                <thead class="table-light">
                  <tr><th style="width:55%" data-i18n="item">Ø§Ù„Ø¨Ù†Ø¯</th><th style="width:25%" data-i18n="amount">Ø§Ù„Ù…Ø¨Ù„Øº</th><th style="width:20%" class="no-print" data-i18n="actions">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr>
                </thead>
                <tbody id="tbl-income"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center section-head" data-bs-toggle="collapse" data-bs-target="#sec-operating">
          <span class="section-title">ğŸ› ï¸ <span data-i18n="operating">Ù…ØµØ±ÙˆÙØ§Øª ØªØ´ØºÙŠÙ„</span></span>
          <div>
            <span class="badge badge-soft me-2"><span data-i18n="sum">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>: <b id="sum-operating">0</b></span>
            <button id="btnAddOp" class="btn btn-sm btn-outline-primary no-print" onclick="addRow('operating')">â• <span data-i18n="addRow">Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯</span></button>
          </div>
        </div>
        <div id="sec-operating" class="collapse show">
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-bordered m-0">
                <thead class="table-light">
                  <tr><th style="width:55%" data-i18n="item">Ø§Ù„Ø¨Ù†Ø¯</th><th style="width:25%" data-i18n="amount">Ø§Ù„Ù…Ø¨Ù„Øº</th><th style="width:20%" class="no-print" data-i18n="actions">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr>
                </thead>
                <tbody id="tbl-operating"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center section-head" data-bs-toggle="collapse" data-bs-target="#sec-install">
          <span class="section-title">ğŸ“† <span data-i18n="installments">Ù…ØµØ±ÙˆÙ Ù…Ù‚Ø³Ù‘Ø· (Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±)</span></span>
          <div>
            <span class="badge badge-soft me-2"><span data-i18n="sum">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>: <b id="sum-installments">0</b></span>
          </div>
        </div>
        <div id="sec-install" class="collapse show">
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-bordered m-0">
                <thead class="table-light">
                  <tr><th style="width:55%" data-i18n="item">Ø§Ù„Ø¨Ù†Ø¯</th><th style="width:25%" data-i18n="amount">Ø§Ù„Ù…Ø¨Ù„Øº</th><th style="width:20%" data-i18n="section">Ø§Ù„Ù‚Ø³Ù…</th></tr>
                </thead>
                <tbody id="tbl-installments"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center section-head" data-bs-toggle="collapse" data-bs-target="#sec-admin">
          <span class="section-title">ğŸ¢ <span data-i18n="admin">Ù…ØµØ±ÙˆÙØ§Øª Ø¥Ø¯Ø§Ø±ÙŠØ©</span></span>
          <div>
            <span class="badge badge-soft me-2"><span data-i18n="sum">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>: <b id="sum-admin">0</b></span>
            <button id="btnAddAdmin" class="btn btn-sm btn-outline-primary no-print" onclick="addRow('admin')">â• <span data-i18n="addRow">Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯</span></button>
          </div>
        </div>
        <div id="sec-admin" class="collapse show">
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-bordered m-0">
                <thead class="table-light">
                  <tr><th style="width:55%" data-i18n="item">Ø§Ù„Ø¨Ù†Ø¯</th><th style="width:25%" data-i18n="amount">Ø§Ù„Ù…Ø¨Ù„Øº</th><th style="width:20%" class="no-print" data-i18n="actions">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr>
                </thead>
                <tbody id="tbl-admin"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header section-title">ğŸ§¾ <span data-i18n="summary">Ø§Ù„Ù…Ù„Ø®Øµ</span></div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-6 col-md-3"><div class="p-3 border rounded bg-light"><span data-i18n="totIncome">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</span>: <b id="s-inc">0</b></div></div>
            <div class="col-6 col-md-3"><div class="p-3 border rounded bg-light"><span data-i18n="totExp">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</span>: <b id="s-exp">0</b></div></div>
            <div class="col-6 col-md-3"><div class="p-3 border rounded bg-light"><span data-i18n="profit">Ø§Ù„Ø±Ø¨Ø­</span>: <b id="s-profit" class="profit-pos">0</b></div></div>
            <div class="col-6 col-md-3"><div class="p-3 border rounded bg-light"><span data-i18n="margin">Ù†Ø³Ø¨Ø© Ø§Ù„Ø±Ø¨Ø­</span>: <b id="s-margin">0%</b></div></div>
            <div class="col-12"><div class="p-3 border rounded">
              <span data-i18n="compareWith">Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ù…Ø¹</span> <span id="cmp-month" class="muted">â€”</span>:
              <span data-i18n="deltaAmt">ÙØ±Ù‚ Ø§Ù„Ù…Ø¨Ù„Øº</span> <b id="cmp-amt">0</b> |
              <span data-i18n="deltaPct">ÙØ±Ù‚ Ø§Ù„Ù†Ø³Ø¨Ø©</span> <b id="cmp-pct">0%</b>
            </div></div>
          </div>
        </div>
      </div>

    </main>
  </div>
</div>

<!-- Modal: Ø¥Ø¶Ø§ÙØ©/Ø¥Ø¯Ø§Ø±Ø© Ù…ØµØ±ÙˆÙ Ù…Ù‚Ø³Ù‘Ø· -->
<div class="modal fade" id="installmentModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h6 class="modal-title" data-i18n="addInstallment">Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ Ù…Ù‚Ø³Ù‘Ø·</h6>
        <button class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
      <div class="modal-body">
        <div class="mb-2"><label class="form-label" data-i18n="itemName">Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ø¯</label>
          <input id="inst-name" class="form-control" placeholder=""></div>

        <div class="mb-2"><label class="form-label" data-i18n="section">Ø§Ù„Ù‚Ø³Ù…</label>
          <select id="inst-section" class="form-select">
            <option value="operating" data-i18n="operating">ØªØ´ØºÙŠÙ„</option>
            <option value="admin" data-i18n="admin">Ø¥Ø¯Ø§Ø±ÙŠ</option>
          </select>
        </div>

        <div class="row g-2">
          <div class="col-6"><label class="form-label" data-i18n="totalAmount">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº</label>
            <input id="inst-total" type="number" class="form-control" value="0"></div>
          <div class="col-6"><label class="form-label" data-i18n="monthsCount">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ù‡Ø±</label>
            <input id="inst-months" type="number" class="form-control" value="3" min="1"></div>
        </div>

        <div class="row g-2 mt-1">
          <div class="col-6"><label class="form-label" data-i18n="startMonth">Ø´Ù‡Ø± Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</label>
            <input id="inst-start" type="month" class="form-control"></div>
          <div class="col-6"><label class="form-label" data-i18n="scope">Ø§Ù„Ù†Ø·Ø§Ù‚</label>
            <select id="inst-scope" class="form-select">
              <option value="single" data-i18n="thisBranch">Ù‡Ø°Ø§ Ø§Ù„ÙØ±Ø¹ ÙÙ‚Ø·</option>
              <option value="weighted" data-i18n="weighted">ØªÙˆØ²ÙŠØ¹ Ø¹Ù„Ù‰ Ø§Ù„ÙØ±ÙˆØ¹ Ø­Ø³Ø¨ Ø§Ù„Ø£ÙˆØ²Ø§Ù†</option>
            </select>
          </div>
        </div>
        <input type="hidden" id="inst-id">
        <small class="text-muted d-block mt-2" data-i18n="instHint">
          Ø³ÙŠÙØ­Ù…Ù‘ÙÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ ÙƒÙ„ Ø´Ù‡Ø±: (Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ã· Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ù‡Ø±). Ø¥Ø°Ø§ Ø§Ø®ØªØ±Øª â€œØªÙˆØ²ÙŠØ¹ Ø¹Ù„Ù‰ Ø§Ù„ÙØ±ÙˆØ¹â€ ÙØ³ÙŠÙÙ‚Ø³Ù‘ÙÙ… Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø´Ù‡Ø±ÙŠ Ø­Ø³Ø¨ Ø£ÙˆØ²Ø§Ù† Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ù„Ù„ÙØ±ÙˆØ¹ Ø§Ù„Ù…ÙØ¹Ù‘Ù„Ø©.
        </small>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="cancel">Ø¥Ù„ØºØ§Ø¡</button>
        <button id="btnSaveInst" class="btn btn-primary" onclick="saveInstallment()" data-i18n="save">Ø­ÙØ¸</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‚Ø³Ù‘Ø· -->
<div class="modal fade" id="manageInstModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header"><h6 class="modal-title" data-i18n="manageInstallments">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‚Ø³Ù‘Ø·</h6>
        <button class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-bordered">
            <thead class="table-light">
              <tr>
                <th data-i18n="item">Ø§Ù„Ø¨Ù†Ø¯</th>
                <th data-i18n="section">Ø§Ù„Ù‚Ø³Ù…</th>
                <th data-i18n="totalAmount">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                <th data-i18n="monthsCount">Ø§Ù„Ø£Ø´Ù‡Ø±</th>
                <th data-i18n="startMonth">Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</th>
                <th class="no-print" data-i18n="actions">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody id="tbl-manage-inst"></tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="close">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Admin ÙÙ‚Ø·) -->
<div class="modal fade" id="usersModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header"><h6 class="modal-title" data-i18n="manageUsers">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h6>
        <button class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
      <div class="modal-body">
        <div class="row g-2 align-items-end">
          <div class="col-md-3">
            <label class="form-label" data-i18n="username">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
            <input id="usr-name" class="form-control">
          </div>
          <div class="col-md-3">
            <label class="form-label" data-i18n="password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <input id="usr-pass" type="password" class="form-control" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢">
          </div>
          <div class="col-md-3">
            <label class="form-label" data-i18n="role">Ø§Ù„Ø¯ÙˆØ±</label>
            <select id="usr-role" class="form-select">
              <option value="admin">admin</option>
              <option value="editor">editor</option>
              <option value="viewer">viewer</option>
            </select>
          </div>
          <div class="col-md-3 d-grid">
            <button class="btn btn-primary" onclick="addOrUpdateUser()"><span data-i18n="save">Ø­ÙØ¸</span></button>
          </div>
        </div>
        <hr>
        <div class="table-responsive">
          <table class="table table-bordered">
            <thead class="table-light">
              <tr>
                <th data-i18n="username">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                <th data-i18n="role">Ø§Ù„Ø¯ÙˆØ±</th>
                <th class="no-print" data-i18n="actions">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody id="tbl-users"></tbody>
          </table>
        </div>
        <small class="text-muted" data-i18n="pwdHashNote">* ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± ØªÙØ­ÙØ¸ ÙƒØ¨ØµÙ…Ø© SHA-256 (Ù„Ø§ ÙŠØªÙ… ØªØ®Ø²ÙŠÙ†Ù‡Ø§ ÙƒÙ†Øµ ØµØ±ÙŠØ­).</small>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="close">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Firebase init (CDN Modules) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getFirestore } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDgtifnouF0AGzBxWls3wPk7gikSqOBFm0",
    authDomain: "monthly-prfits.firebaseapp.com",
    projectId: "monthly-prfits",
    storageBucket: "monthly-prfits.firebasestorage.app",
    messagingSenderId: "896730662080",
    appId: "1:896730662080:web:a41850c6736ab6b02d1925",
    measurementId: "G-KX9KFLVV3J"
  };
  const app = initializeApp(firebaseConfig);
  window._db = getFirestore(app);
</script>

<script>
/* ================= I18N ================= */
const I18N = {
  ar:{ appTitle:"Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ø´Ù‡Ø±ÙŠ", loginTitle:"ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„", username:"Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…", password:"ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±", login:"Ø¯Ø®ÙˆÙ„", logout:"Ø®Ø±ÙˆØ¬",
       import:"Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª", exportJson:"ØªØµØ¯ÙŠØ± JSON", exportExcel:"ØªØµØ¯ÙŠØ± Excel", saveCloud:"Ø­ÙØ¸ Ø³Ø­Ø§Ø¨ÙŠ", loadCloud:"ØªØ­Ù…ÙŠÙ„ Ø³Ø­Ø§Ø¨ÙŠ", print:"Ø·Ø¨Ø§Ø¹Ø©",
       branches:"Ø§Ù„ÙØ±ÙˆØ¹", adminSettings:"Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ", adminHint:"* Ø§Ù„ÙØ±ÙˆØ¹ Ø§Ù„Ù…ÙØ¹Ù‘ÙÙ„Ø© ÙÙ‚Ø· ØªØªØ­Ù…Ù„ Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ Ø§Ù„Ù…Ù‚Ø³Ù‘Ø· Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± â€œØªÙˆØ²ÙŠØ¹ Ø¹Ù„Ù‰ Ø§Ù„ÙØ±ÙˆØ¹â€.",
       wipe:"Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©", confirmWipe:"Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©ØŸ",
       reportMonth:"Ø´Ù‡Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ±", compareWith:"Ù…Ù‚Ø§Ø±Ù†Ø© Ù…Ø¹", copyFromCmp:"Ù†Ø³Ø® Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ù‚Ø§Ø±ÙÙ†",
       addInstallment:"Ù…ØµØ±ÙˆÙ Ù…Ù‚Ø³Ù‘Ø·", manageInstallments:"Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‚Ø³Ù‘Ø·", manageUsers:"Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†", close:"Ø¥ØºÙ„Ø§Ù‚",
       income:"Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª", operating:"Ù…ØµØ±ÙˆÙØ§Øª ØªØ´ØºÙŠÙ„", installments:"Ù…ØµØ±ÙˆÙ Ù…Ù‚Ø³Ù‘Ø· (Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±)", admin:"Ù…ØµØ±ÙˆÙØ§Øª Ø¥Ø¯Ø§Ø±ÙŠØ©",
       sum:"Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ", addRow:"Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯", item:"Ø§Ù„Ø¨Ù†Ø¯", amount:"Ø§Ù„Ù…Ø¨Ù„Øº", actions:"Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª", section:"Ø§Ù„Ù‚Ø³Ù…",
       summary:"Ø§Ù„Ù…Ù„Ø®Øµ", totIncome:"Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª", totExp:"Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª", profit:"Ø§Ù„Ø±Ø¨Ø­", margin:"Ù†Ø³Ø¨Ø© Ø§Ù„Ø±Ø¨Ø­",
       deltaAmt:"ÙØ±Ù‚ Ø§Ù„Ù…Ø¨Ù„Øº", deltaPct:"ÙØ±Ù‚ Ø§Ù„Ù†Ø³Ø¨Ø©", itemName:"Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ø¯", totalAmount:"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº",
       monthsCount:"Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ù‡Ø±", startMonth:"Ø´Ù‡Ø± Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©", scope:"Ø§Ù„Ù†Ø·Ø§Ù‚",
       thisBranch:"Ù‡Ø°Ø§ Ø§Ù„ÙØ±Ø¹ ÙÙ‚Ø·", weighted:"ØªÙˆØ²ÙŠØ¹ Ø¹Ù„Ù‰ Ø§Ù„ÙØ±ÙˆØ¹ Ø­Ø³Ø¨ Ø§Ù„Ø£ÙˆØ²Ø§Ù†", instHint:"Ø³ÙŠÙØ­Ù…Ù‘ÙÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ ÙƒÙ„ Ø´Ù‡Ø±: (Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ã· Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ù‡Ø±). Ø¥Ø°Ø§ Ø§Ø®ØªØ±Øª â€œØªÙˆØ²ÙŠØ¹ Ø¹Ù„Ù‰ Ø§Ù„ÙØ±ÙˆØ¹â€ ÙØ³ÙŠÙÙ‚Ø³Ù‘ÙÙ… Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø´Ù‡Ø±ÙŠ Ø­Ø³Ø¨ Ø£ÙˆØ²Ø§Ù† Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ù„Ù„ÙØ±ÙˆØ¹ Ø§Ù„Ù…ÙØ¹Ù‘Ù„Ø©.",
       cancel:"Ø¥Ù„ØºØ§Ø¡", save:"Ø­ÙØ¸", role:"Ø§Ù„Ø¯ÙˆØ±",
       pwdHashNote:"* ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± ØªÙØ­ÙØ¸ ÙƒØ¨ØµÙ…Ø© SHA-256 (Ù„Ø§ ÙŠØªÙ… ØªØ®Ø²ÙŠÙ†Ù‡Ø§ ÙƒÙ†Øµ ØµØ±ÙŠØ­).",
       notAllowed:"ØµÙ„Ø§Ø­ÙŠØ§ØªÙƒ Ù„Ø§ ØªØ³Ù…Ø­ Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©.",
       usersMerged:"ØªÙ…Øª Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.",
       cloudSaved:"ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø³Ø­Ø§Ø¨ÙŠÙ‹Ø§", cloudLoaded:"ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©", noCloud:"Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³Ø­Ø§Ø¨Ø©", noData:"Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª."
  },
  en:{ appTitle:"Monthly Profit App", loginTitle:"Sign in", username:"Username", password:"Password", login:"Login", logout:"Logout",
       import:"Import JSON", exportJson:"Export JSON", exportExcel:"Export Excel", saveCloud:"Save Cloud", loadCloud:"Load Cloud", print:"Print",
       branches:"Branches", adminSettings:"Admin allocation", adminHint:"* Only enabled branches share admin installments when 'weighted' is selected.",
       wipe:"Clear local data", confirmWipe:"Clear all local data?",
       reportMonth:"Report month", compareWith:"Compare with", copyFromCmp:"Copy from compared month",
       addInstallment:"Installment", manageInstallments:"Manage installments", manageUsers:"Manage users", close:"Close",
       income:"Income", operating:"Operating expenses", installments:"Installments (this month)", admin:"Administrative expenses",
       sum:"Total", addRow:"Add row", item:"Item", amount:"Amount", actions:"Actions", section:"Section",
       summary:"Summary", totIncome:"Total income", totExp:"Total expenses", profit:"Profit", margin:"Profit margin",
       deltaAmt:"Amount delta", deltaPct:"Margin delta", itemName:"Item name", totalAmount:"Total amount",
       monthsCount:"Months", startMonth:"Start month", scope:"Scope",
       thisBranch:"This branch only", weighted:"Weighted across branches", instHint:"A monthly share (total Ã· months) is auto-applied. If 'weighted', it splits by branch weights.",
       cancel:"Cancel", save:"Save", role:"Role",
       pwdHashNote:"* Passwords are stored as SHA-256 hashes.",
       notAllowed:"Your role does not permit this action.",
       usersMerged:"Users synced.",
       cloudSaved:"Saved to cloud", cloudLoaded:"Loaded from cloud", noCloud:"No cloud connection", noData:"No data."
  }
};
let LANG='ar';
function t(k){return (I18N[LANG]||{})[k]||k}
function applyLang(){
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    el.textContent = t(el.getAttribute('data-i18n'));
  });
  document.documentElement.setAttribute('lang',LANG);
  document.documentElement.setAttribute('dir',LANG==='ar'?'rtl':'ltr');
  renderPage();
}
['btn-ar','btn-en','nav-btn-ar','nav-btn-en'].forEach(id=>{
  const el=document.getElementById(id); if(!el) return;
  el.addEventListener('click',()=>{
    LANG = id.endsWith('ar')?'ar':'en';
    applyLang();
  });
});

/* ================= Ù…ÙØ§ØªÙŠØ­ Ø§Ù„ØªØ®Ø²ÙŠÙ† ================= */
const STORE_KEY = "profit_manager_v3";
const USERS_KEY = "profit_users_v1";
const SESSION_KEY = "profit_session_v1";

/* ================= Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ================= */
const FIXED_BRANCHES = [
  {id: cid(), name:"Ø§Ù„Ø­ÙÙ„Ø§Øª", active:true,  weight:1, includeAdmin:true},
  {id: cid(), name:"Ø§Ù„ÙƒÙŠØª",   active:true,  weight:1, includeAdmin:true},
  {id: cid(), name:"ÙƒÙ„Ø§Ø³ÙŠÙƒ",  active:true,  weight:1, includeAdmin:true},
  {id: cid(), name:"Ù…ÙˆÙ†Ø¯",    active:true,  weight:1, includeAdmin:true},
  {id: cid(), name:"Ù‡ÙˆØ±Ù†",    active:true,  weight:1, includeAdmin:true},
  {id: cid(), name:"Ù‡Ø¬Ø± ÙÙˆØ¯", active:true,  weight:1, includeAdmin:false}
];
const DEFAULT_DB = { branches: FIXED_BRANCHES, months:{}, installments:[] };
let DB = loadLocal();
let currentBranchId = DB.branches[0]?.id || null;
let currentMonth = new Date().toISOString().slice(0,7);
let compareMonth = "";

/* ================= Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† + Ù‡ÙØ´ ================= */
function loadUsers(){
  const raw=localStorage.getItem(USERS_KEY);
  if(raw){ try{ return JSON.parse(raw);}catch{return []} }
  return [];
}
function saveUsers(arr){ localStorage.setItem(USERS_KEY, JSON.stringify(arr||[])); autoSaveUsersCloud(); }
async function sha256(txt){
  const enc = new TextEncoder().encode(txt);
  const buf = await crypto.subtle.digest('SHA-256', enc);
  return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
}
function seedDefaultAdminIfNeeded(){
  let users = loadUsers();
  if(users.length===0){
    // admin / admin442
    sha256('admin442').then(hash=>{
      users = [{username:'admin', passHash:hash, role:'admin', createdAt:new Date().toISOString()}];
      saveUsers(users);
    });
  }
}
seedDefaultAdminIfNeeded();

function getSession(){
  try{ return JSON.parse(localStorage.getItem(SESSION_KEY)||'null'); }catch{return null}
}
function setSession(obj){
  if(obj) localStorage.setItem(SESSION_KEY, JSON.stringify(obj));
  else localStorage.removeItem(SESSION_KEY);
}

/* ================= ØµÙ„Ø§Ø­ÙŠØ§Øª ================= */
function canEdit(){ const s=getSession(); return s && (s.role==='admin' || s.role==='editor'); }
function isAdmin(){ const s=getSession(); return s && s.role==='admin'; }
function isViewer(){ const s=getSession(); return s && s.role==='viewer'; }

/* ================= ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„/Ø§Ù„Ø®Ø±ÙˆØ¬ ================= */
const loginUser=document.getElementById('loginUser');
const loginPass=document.getElementById('loginPass');
document.getElementById('btnDoLogin').addEventListener('click', doLogin);
loginPass.addEventListener('keydown',e=>{ if(e.key==='Enter') doLogin(); });

async function doLogin(){
  const u=loginUser.value.trim();
  const p=loginPass.value;
  if(!u||!p){ showLoginMsg(LANG==='ar'?'Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.':'Enter username and password.'); return; }
  const users=loadUsers();
  const found=users.find(x=>x.username===u);
  if(!found){ showLoginMsg(LANG==='ar'?'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.':'User not found.'); return; }
  const hash=await sha256(p);
  if(hash!==found.passHash){ showLoginMsg(LANG==='ar'?'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.':'Wrong password.'); return; }
  setSession({username:found.username, role:found.role, loginAt:Date.now()});
  loginUser.value=""; loginPass.value="";
  showApp();
  // Ù…Ø²Ø§Ù…Ù†Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„: Ø­Ù…Ù‘Ù„ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø© Ø«Ù… Ø§Ø­ÙØ¸ Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ù…Ø¬
  await autoLoadCloud();
  autoSaveCloud();
}
function showLoginMsg(msg){ document.getElementById('loginMsg').textContent=msg; }

function showApp(){
  document.getElementById('loginScreen').classList.add('d-none');
  document.getElementById('appNavbar').classList.remove('d-none');
  document.getElementById('appShell').classList.remove('d-none');
  // Ø²Ø± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù„Ù„Ù€ admin ÙÙ‚Ø·
  document.getElementById('btnUsers').classList.toggle('d-none', !isAdmin());
  // Ø´Ø§Ø±Ø§Øª Ø§Ù„Ø¯ÙˆØ±
  const s=getSession();
  const badge=document.getElementById('currentRoleBadge');
  badge.textContent = s ? (LANG==='ar'?'Ø§Ù„Ø¯ÙˆØ±: ':'Role: ')+s.role : 'â€”';
  // ØªØ¹Ø·ÙŠÙ„ Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­Ø±ÙŠØ± Ø¥Ù† ÙƒØ§Ù† viewer
  enforceRoleUI();
  renderBranches(); renderPage();
}
function doLogout(){
  setSession(null);
  location.reload();
}

/* ================= UI Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ± ================= */
function enforceRoleUI(){
  const viewer = isViewer();
  ['btnAddIncome','btnAddOp','btnAddAdmin','btnCopyPrev','btnAddInst','btnManageInst','btnSaveCloud'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.disabled = viewer;
  });
  const loadBtn=document.getElementById('btnLoadCloud'); if(loadBtn) loadBtn.disabled=false;
}

/* ================= ØªØ®Ø²ÙŠÙ† Ù…Ø­Ù„ÙŠ ================= */
function loadLocal(){
  try{ return JSON.parse(localStorage.getItem(STORE_KEY) || JSON.stringify(DEFAULT_DB)); }
  catch{ return JSON.parse(JSON.stringify(DEFAULT_DB)); }
}
function saveLocal(){ localStorage.setItem(STORE_KEY, JSON.stringify(DB)); }

/* ================= Ø£Ø¯ÙˆØ§Øª ================= */
function cid(){ return Math.random().toString(36).slice(2,10); }
function sumRows(rows){ return rows.reduce((s,r)=> s + (+r.amount||0), 0); }
function numberFmt(n){ return (+n||0).toLocaleString(LANG==='ar'?'ar-EG':'en-US', {maximumFractionDigits:2}); }

/* ================= ÙØ±ÙˆØ¹ + Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ================= */
function renderBranches(){
  const list=document.getElementById('branchList'); list.innerHTML="";
  DB.branches.forEach(b=>{
    const a=document.createElement('a');
    a.href="#"; a.className="list-group-item d-flex align-items-center justify-content-between";
    if(b.id===currentBranchId) a.classList.add('active');
    a.innerHTML=`<span>${b.name}</span>`;
    a.onclick=(e)=>{e.preventDefault(); currentBranchId=b.id; renderPage();};
    list.appendChild(a);
  });

  const box=document.getElementById('adminSettings'); box.innerHTML="";
  DB.branches.forEach(b=>{
    const row=document.createElement('div'); row.className="d-flex align-items-center gap-2";
    row.innerHTML=`
      <input type="checkbox" class="form-check-input" ${b.includeAdmin?'checked':''}
        onchange="bToggleAdmin('${b.id}',this.checked)" ${isViewer()?'disabled':''}>
      <span class="me-1" style="width:120px">${b.name}</span>
      <input type="number" class="form-control form-control-sm" style="width:90px"
        value="${b.weight}" min="0" step="0.1" onchange="bSetWeight('${b.id}',this.value)" ${isViewer()?'disabled':''}>
      <span class="muted">${LANG==='ar'?'ÙˆØ²Ù†':'Weight'}</span>`;
    box.appendChild(row);
  });
}
function bToggleAdmin(id,val){ if(isViewer()) return; const b=DB.branches.find(x=>x.id===id); if(b){ b.includeAdmin=!!val; saveLocal(); autoSaveCloud(); } }
function bSetWeight(id,v){ if(isViewer()) return; const b=DB.branches.find(x=>x.id===id); if(b){ b.weight=parseFloat(v)||0; saveLocal(); autoSaveCloud(); } }

/* ================= ØµÙØ­Ø© Ø§Ù„ÙØ±Ø¹ ================= */
function ensureMonthBranch(mm,bid){
  DB.months[mm]=DB.months[mm]||{};
  DB.months[mm][bid]=DB.months[mm][bid]||{income:[],operating:[],admin:[]};
  return DB.months[mm][bid];
}
document.getElementById('monthCurrent').addEventListener('change',e=>{ currentMonth=e.target.value; renderPage(); });
document.getElementById('monthCompare').addEventListener('change',e=>{ compareMonth=e.target.value; updateSummary(); });

function renderPage(){
  if(!currentBranchId){ document.getElementById('branchTitle').textContent='â€”'; return; }
  document.getElementById('branchTitle').textContent = DB.branches.find(b=>b.id===currentBranchId)?.name || 'â€”';
  document.getElementById('monthCurrent').value = currentMonth;
  document.getElementById('monthCompare').value = compareMonth;

  renderTable('income'); renderTable('operating'); renderTable('admin');
  renderInstallmentsSnapshot();
  updateSummary();
}

function addRow(section){
  if(!canEdit()) return alert(t('notAllowed'));
  const rows=ensureMonthBranch(currentMonth,currentBranchId)[section];
  rows.push({name: LANG==='ar'?'Ø¨Ù†Ø¯ Ø¬Ø¯ÙŠØ¯':'New item', amount:0});
  saveLocal(); autoSaveCloud(); renderTable(section); updateSummary();
}
function delRow(section, idx){
  if(!canEdit()) return alert(t('notAllowed'));
  ensureMonthBranch(currentMonth,currentBranchId)[section].splice(idx,1);
  saveLocal(); autoSaveCloud(); renderTable(section); updateSummary();
}
function editCell(section, idx, field, val){
  if(!canEdit()) return;
  const rows=ensureMonthBranch(currentMonth,currentBranchId)[section];
  if(!rows[idx]) return;
  rows[idx][field]= field==='amount' ? (parseFloat(val)||0) : val;
  saveLocal(); autoSaveCloud(); updateSummary();
}

function renderTable(section){
  const tbody=document.getElementById('tbl-'+section); tbody.innerHTML="";
  const rows=ensureMonthBranch(currentMonth,currentBranchId)[section];

  const autoRows = calcInstallmentsFor(currentMonth,currentBranchId,section)
    .map(x=>({name:`(${LANG==='ar'?'Ù…Ù‚Ø³Ù‘Ø·':'Install.'}) ${x.name}`, amount:x.amount, _auto:true}));

  const all = rows.concat(autoRows);
  all.forEach((r,i)=>{
    const tr=document.createElement('tr');
    const nameTd = r._auto ? r.name : `<input type="text" value="${r.name}" ${isViewer()?'disabled':''}
                        oninput="editCell('${section}',${i},'name',this.value)">`;
    const amtTd  = r._auto ? numberFmt(r.amount) : `<input type="number" value="${r.amount}" ${isViewer()?'disabled':''}
                        oninput="editCell('${section}',${i},'amount',this.value)">`;
    const actTd  = r._auto ? '<span class="text-muted">â€”</span>'
                 : `<button class="btn btn-sm btn-outline-danger" ${isViewer()?'disabled':''}
                        onclick="delRow('${section}',${i})">${LANG==='ar'?'Ø­Ø°Ù':'Delete'}</button>`;
    tr.innerHTML=`<td>${nameTd}</td><td>${amtTd}</td><td class="no-print">${actTd}</td>`;
    tbody.appendChild(tr);
  });

  const sums=computeTotals(currentMonth,currentBranchId);
  document.getElementById('sum-'+section).textContent =
    section==='income'? numberFmt(sums.inc) : section==='operating'? numberFmt(sums.op) : numberFmt(sums.ad);
}

/* ================= Ø§Ù„Ù…Ù‚Ø³Ù‘Ø· ================= */
const instModal = new bootstrap.Modal('#installmentModal');
const manageInstModal = new bootstrap.Modal('#manageInstModal');

function openInstallment(){
  if(!canEdit()) return alert(t('notAllowed'));
  document.getElementById('inst-id').value='';
  document.getElementById('inst-name').value='';
  document.getElementById('inst-total').value=0;
  document.getElementById('inst-months').value=3;
  document.getElementById('inst-section').value='operating';
  document.getElementById('inst-start').value=currentMonth;
  document.getElementById('inst-scope').value='single';
  instModal.show();
}
function saveInstallment(){
  if(!canEdit()) return alert(t('notAllowed'));
  const id=document.getElementById('inst-id').value;
  const name=document.getElementById('inst-name').value.trim();
  const total=parseFloat(document.getElementById('inst-total').value)||0;
  const months=Math.max(1, parseInt(document.getElementById('inst-months').value)||1);
  const start=document.getElementById('inst-start').value;
  const section=document.getElementById('inst-section').value;
  const scope=document.getElementById('inst-scope').value;
  if(!name||!start){ alert(LANG==='ar'?'Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„.':'Complete required fields.'); return; }
  if(id){
    const it=DB.installments.find(x=>x.id===id);
    if(it){ Object.assign(it,{name,total,months,start,section,scope}); }
  }else{
    DB.installments.push({id:cid(), name,total,months,start,section,scope,branchId:currentBranchId,created:new Date().toISOString()});
  }
  saveLocal(); autoSaveCloud(); instModal.hide(); renderTable(section); renderInstallmentsSnapshot(); updateSummary();
}
function openManageInstallments(){
  if(!canEdit()) return alert(t('notAllowed'));
  const tbody=document.getElementById('tbl-manage-inst'); tbody.innerHTML="";
  DB.installments.forEach(it=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${it.name}</td>
      <td>${it.section==='operating'?(LANG==='ar'?'ØªØ´ØºÙŠÙ„':'Operating'):(LANG==='ar'?'Ø¥Ø¯Ø§Ø±ÙŠ':'Admin')}</td>
      <td>${numberFmt(it.total)}</td>
      <td>${it.months}</td>
      <td>${it.start}</td>
      <td class="no-print d-flex gap-2">
        <button class="btn btn-sm btn-outline-primary" onclick="editInst('${it.id}')">${LANG==='ar'?'ØªØ¹Ø¯ÙŠÙ„':'Edit'}</button>
        <button class="btn btn-sm btn-outline-danger" onclick="delInst('${it.id}')">${LANG==='ar'?'Ø­Ø°Ù':'Delete'}</button>
      </td>`;
    tbody.appendChild(tr);
  });
  manageInstModal.show();
}
function editInst(id){
  const it=DB.installments.find(x=>x.id===id); if(!it) return;
  document.getElementById('inst-id').value=it.id;
  document.getElementById('inst-name').value=it.name;
  document.getElementById('inst-total').value=it.total;
  document.getElementById('inst-months').value=it.months;
  document.getElementById('inst-section').value=it.section;
  document.getElementById('inst-start').value=it.start;
  document.getElementById('inst-scope').value=it.scope||'single';
  manageInstModal.hide(); instModal.show();
}
function delInst(id){
  if(!canEdit()) return;
  DB.installments = DB.installments.filter(x=>x.id!==id);
  saveLocal(); autoSaveCloud(); openManageInstallments(); renderInstallmentsSnapshot(); renderTable('operating'); renderTable('admin'); updateSummary();
}
function monthAdd(ym,k){ const [y,m]=ym.split('-').map(Number); const d=new Date(y, m-1+k,1); return d.toISOString().slice(0,7); }
function calcInstallmentsFor(ym,bid,section){
  const perMonth=[];
  DB.installments.forEach(ins=>{
    if(ins.section!==section) return;
    const end=monthAdd(ins.start, ins.months-1);
    if(ym<ins.start || ym>end) return;
    const mAmount=ins.total/ins.months;
    if((ins.scope||'single')==='single'){
      if(ins.branchId===bid) perMonth.push({name:ins.name, amount:mAmount});
    }else{
      const eligible = DB.branches.filter(b=> section==='admin'? b.includeAdmin : true);
      const weights = eligible.reduce((s,b)=> s+(+b.weight||0), 0) || 1;
      const b=DB.branches.find(x=>x.id===bid);
      const w= eligible.find(x=>x.id===bid) ? ((+b.weight||0)/weights) : 0;
      perMonth.push({name:ins.name, amount:mAmount*w});
    }
  });
  return perMonth;
}
function renderInstallmentsSnapshot(){
  const tbody=document.getElementById('tbl-installments'); tbody.innerHTML="";
  let total=0;
  ['operating','admin'].forEach(sec=>{
    const rows=calcInstallmentsFor(currentMonth,currentBranchId,sec);
    rows.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${r.name}</td><td>${numberFmt(r.amount)}</td><td>${sec==='operating'?(LANG==='ar'?'ØªØ´ØºÙŠÙ„':'Operating'):(LANG==='ar'?'Ø¥Ø¯Ø§Ø±ÙŠ':'Admin')}</td>`;
      tbody.appendChild(tr);
      total += (+r.amount||0);
    });
  });
  document.getElementById('sum-installments').textContent=numberFmt(total);
}

/* ================= Ù…Ù„Ø®Øµ ÙˆÙ…Ù‚Ø§Ø±Ù†Ø© ================= */
function computeTotals(month,bid){
  const incRows=ensureMonthBranch(month,bid)['income'];
  const opRows =ensureMonthBranch(month,bid)['operating'].concat(calcInstallmentsFor(month,bid,'operating'));
  const adRows =ensureMonthBranch(month,bid)['admin'].concat(calcInstallmentsFor(month,bid,'admin'));
  const inc=sumRows(incRows), op=sumRows(opRows), ad=sumRows(adRows);
  const exp=op+ad, profit=inc-exp, margin=inc>0?(profit/inc*100):0;
  return {inc,op,ad,exp,profit,margin};
}
function updateSummary(){
  const t = computeTotals(currentMonth,currentBranchId);
  document.getElementById('s-inc').textContent=numberFmt(t.inc);
  document.getElementById('s-exp').textContent=numberFmt(t.exp);
  const pEl=document.getElementById('s-profit'); pEl.textContent=numberFmt(t.profit);
  pEl.className = t.profit>=0 ? 'profit-pos' : 'profit-neg';
  document.getElementById('s-margin').textContent=(t.margin||0).toFixed(2)+'%';

  let deltaAmt=0, deltaPct=0;
  if(compareMonth){
    const c=computeTotals(compareMonth,currentBranchId);
    deltaAmt=t.profit - c.profit;
    const pctA=t.inc>0?(t.profit/t.inc*100):0;
    const pctB=c.inc>0?(c.profit/c.inc*100):0;
    deltaPct=pctA-pctB; document.getElementById('cmp-month').textContent=compareMonth;
  }else document.getElementById('cmp-month').textContent='â€”';
  document.getElementById('cmp-amt').textContent=numberFmt(deltaAmt);
  document.getElementById('cmp-pct').textContent=(deltaPct||0).toFixed(2)+'%';

  document.getElementById('sum-income').textContent=numberFmt(t.inc);
  document.getElementById('sum-operating').textContent=numberFmt(t.op);
  document.getElementById('sum-admin').textContent=numberFmt(t.ad);

  saveLocal();
}

/* ================= Ù†Ø³Ø® Ù…Ù† Ø´Ù‡Ø± Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© ================= */
function copyFromPrevious(){
  if(!canEdit()) return alert(t('notAllowed'));
  if(!compareMonth){ return alert(LANG==='ar'?'Ø§Ø®ØªØ± Ø´Ù‡Ø± Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ø£ÙˆÙ„Ø§Ù‹.':'Pick compare month first.'); }
  if(!confirm(LANG==='ar'?'Ù†Ø³Ø® Ø§Ù„Ø¨Ù†ÙˆØ¯ Ù…Ù† Ø´Ù‡Ø± Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ø¥Ù„Ù‰ Ø´Ù‡Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ±ØŸ (Ù„Ù† ÙŠØ´Ù…Ù„ Ø§Ù„Ù…Ù‚Ø³Ù‘Ø·)':'Copy items (installments excluded)?')) return;
  const src=ensureMonthBranch(compareMonth,currentBranchId);
  const dst=ensureMonthBranch(currentMonth,currentBranchId);
  ['income','operating','admin'].forEach(sec=>{ dst[sec]=JSON.parse(JSON.stringify(src[sec]||[])); });
  saveLocal(); autoSaveCloud(); renderTable('income'); renderTable('operating'); renderTable('admin'); updateSummary();
}

/* ================= Ø§Ø³ØªÙŠØ±Ø§Ø¯/ØªØµØ¯ÙŠØ± ================= */
function exportJSON(){
  const blob=new Blob([JSON.stringify(DB,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a');
  a.href=url; a.download='profit-data.json'; a.click(); URL.revokeObjectURL(url);
}
document.getElementById('importFile').addEventListener('change',e=>{
  if(!canEdit()) { e.target.value=''; return alert(t('notAllowed')); }
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>{ try{ DB=JSON.parse(r.result); saveLocal(); autoSaveCloud(); location.reload(); } catch{ alert(LANG==='ar'?'Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­':'Invalid file'); } };
  r.readAsText(f);
});

/* ================= Ø³Ø­Ø§Ø¨Ø© (Firestore) ================= */
async function manualSaveCloud(){ await saveToCloud(DB); alert(t('cloudSaved')); }
async function manualLoadCloud(){ const ok=await loadFromCloud(); alert(ok?t('cloudLoaded'):t('noData')); }
async function autoLoadCloud(){ return await loadFromCloud(); }
function autoSaveCloud(){ debounce(async()=>{ await saveToCloud(DB); }, 800)(); }
function autoSaveUsersCloud(){ debounce(async()=>{ await saveUsersToCloud(); }, 800)(); }

async function saveToCloud(data){
  if(!window._db){ console.warn(t('noCloud')); return false; }
  try{
    const { doc, setDoc } = await import("https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js");
    await setDoc(doc(window._db,'profits','main'), {content:JSON.stringify(data), updatedAt:new Date().toISOString()});
    return true;
  }catch(e){ console.error(e); return false; }
}
async function loadFromCloud(){
  if(!window._db){ console.warn(t('noCloud')); return false; }
  try{
    const { doc, getDoc, setDoc } = await import("https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js");
    const ref=doc(window._db,'profits','main');
    const snap=await getDoc(ref);
    if(!snap.exists()){
      await setDoc(ref,{content:JSON.stringify(DB), updatedAt:new Date().toISOString()});
      return false;
    }
    const cloud=JSON.parse(snap.data().content||'{}');
    if(cloud && typeof cloud==='object'){
      DB = mergeDB(DB, cloud);
      saveLocal();
      renderBranches(); renderPage();
      return true;
    }
    return false;
  }catch(e){ console.error(e); return false; }
}

async function saveUsersToCloud(){
  if(!window._db) return false;
  try{
    const { doc, setDoc } = await import("https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js");
    await setDoc(doc(window._db,'profits','users'), {users: loadUsers(), updatedAt:new Date().toISOString()});
    return true;
  }catch(e){ console.error(e); return false; }
}
async function loadUsersFromCloud(){
  if(!window._db) return false;
  try{
    const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js");
    const snap=await getDoc(doc(window._db,'profits','users'));
    if(snap.exists()){
      const cloudUsers=snap.data().users||[];
      const map=new Map();
      [...loadUsers(), ...cloudUsers].forEach(u=>{ map.set(u.username, u); });
      saveUsers([...map.values()]);
      return true;
    }
    return false;
  }catch(e){ console.error(e); return false; }
}

/* ================= Ø¯Ù…Ø¬ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ================= */
function mergeDB(local, cloud){
  const out = JSON.parse(JSON.stringify(local));
  for(const mm of Object.keys(cloud.months||{})){
    out.months[mm]=out.months[mm]||{};
    for(const bid of Object.keys(cloud.months[mm])){
      out.months[mm][bid]=out.months[mm][bid]||{income:[],operating:[],admin:[]};
    }
  }
  // fix: merge rows per section
  for(const mm of Object.keys(cloud.months||{})){
    for(const bid of Object.keys(cloud.months[mm])){
      ['income','operating','admin'].forEach(sec=>{
        const loc = (out.months[mm][bid][sec]||[]);
        const cld = (cloud.months[mm][bid][sec]||[]);
        out.months[mm][bid][sec] = mergeRows(loc, cld);
      });
    }
  }
  const idx=new Map(out.installments.map(x=>[x.id,x]));
  (cloud.installments||[]).forEach(it=>{ if(!idx.has(it.id)) out.installments.push(it); });
  return out;
}
function mergeRows(a,b){
  const out=[...a];
  b.forEach(r=>{
    if(!out.find(x=>x.name===r.name && (+x.amount||0)===(+r.amount||0))) out.push(r);
  });
  return out;
}

/* ================= Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ================= */
function refreshUsersTable(){
  const tb=document.getElementById('tbl-users'); tb.innerHTML="";
  loadUsers().forEach(u=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${u.username}</td>
      <td>${u.role}</td>
      <td class="no-print d-flex gap-2">
        <button class="btn btn-sm btn-outline-primary" onclick="prefillUser('${u.username}')">${LANG==='ar'?'ØªØ¹Ø¯ÙŠÙ„':'Edit'}</button>
        <button class="btn btn-sm btn-outline-danger" onclick="deleteUser('${u.username}')">${LANG==='ar'?'Ø­Ø°Ù':'Delete'}</button>
      </td>`;
    tb.appendChild(tr);
  });
}
function prefillUser(username){
  const u=loadUsers().find(x=>x.username===username); if(!u) return;
  document.getElementById('usr-name').value=u.username;
  document.getElementById('usr-pass').value='';
  document.getElementById('usr-role').value=u.role;
}
async function addOrUpdateUser(){
  const name=document.getElementById('usr-name').value.trim();
  const pass=document.getElementById('usr-pass').value;
  const role=document.getElementById('usr-role').value;
  if(!name) return;
  const arr=loadUsers();
  const i=arr.findIndex(x=>x.username===name);
  if(pass){
    const hash=await sha256(pass);
    const obj={username:name, passHash:hash, role, updatedAt:new Date().toISOString()};
    if(i>=0) arr[i]=Object.assign(arr[i], obj); else arr.push(obj);
  }else{
    if(i>=0){ arr[i].role=role; arr[i].updatedAt=new Date().toISOString(); }
    else return; // Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø¯ÙˆÙ† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±
  }
  saveUsers(arr); refreshUsersTable();
  document.getElementById('usr-name').value='';
  document.getElementById('usr-pass').value='';
  document.getElementById('usr-role').value='viewer';
}
function deleteUser(username){
  if(username==='admin') { alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø­Ø³Ø§Ø¨ admin'); return; }
  const arr=loadUsers().filter(x=>x.username!==username);
  saveUsers(arr); refreshUsersTable();
}

/* ================= Ø£Ø¯ÙˆØ§Øª Ø¹Ø§Ù…Ø© ================= */
function wipeLocalConfirm(){
  if(!confirm(t('confirmWipe'))) return;
  localStorage.removeItem(STORE_KEY);
  location.reload();
}

/* ================= Ø£Ø­Ø¯Ø§Ø« ================= */
document.getElementById('usersModal').addEventListener('show.bs.modal', refreshUsersTable);

/* ================= ØªÙ‡ÙŠØ¦Ø© ================= */
(function init(){
  LANG='ar'; applyLang();
  currentMonth=new Date().toISOString().slice(0,7);
  compareMonth="";
  const s=getSession();
  if(s && s.username){
    showApp();
    autoLoadCloud().then(()=> autoSaveCloud());
    loadUsersFromCloud().then(()=> console.log(t('usersMerged')));
  }else{
    document.getElementById('loginScreen').classList.remove('d-none');
  }
})();

/* ================= Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ================= */
function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }
</script>
</body>
</html>
